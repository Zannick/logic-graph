name: Annuna Gorge
short: Annuna

areas:
- name: Mirror Match  # MARK: Mirror Match
  on_entry: $reset_old_area(^newpos)
  map:
    save: [32, 25, 33, 26]
  data:
    save_point: Save Point
  spots:
    #region Main area
    - name: West 25
      coord: [32.05, 24.8]
      local:
        - to: West Gap
      exits:
        - to: Uhrum > Annuna Corridor > East 25
          tags: [xshift]
    - name: West Gap
      coord: [32.2, 25.0]
      local:
        - to: Save Point
    - name: Save Point
      coord: [32.5, 25.4]
      local:
        - to: Eastward
      locations:
        - name: Fight
          item: Defeat_Indra
          req: Separation
          time: 30  # ?
      actions:
        - name: Save
          req: NOT Separation or Defeat_Indra
          do: $save
    - name: Eastward
      coord: [32.95, 25.4]
      local:
        - to: Save Point
      exits:
        - to: Staircase
          req: NOT Separation or Defeat_Indra
          movement: base
        - to: Staircase
          req: Separation and NOT Defeat_Indra and $mist2
          price: 30
          movement: mist2
    - name: Staircase
      coord: [33.1, 25.4]
      local:
        - to: East 25 Lower
          jumps: 4
      exits:
        - to: Eastward
          req: NOT Separation or Defeat_Indra
          movement: base
        - to: Eastward
          req: Separation and NOT Defeat_Indra and $mist2
          price: 30
          movement: mist2
    - name: East 25 Lower
      coord: [33.95, 24.8]
      local:
        - to: Staircase
      exits:
        - to: West Bridge > West 25 Lower
          tags: [xshift]
    #endregion

    #region Upper Area
    - name: East 25 Upper
      coord: [33.95, 24.3]
      local:
        - to: Below Switch
      exits:
        - to: West Bridge > West 25 Upper
          tags: [xshift]
    - name: Below Switch
      coord: [33.6, 24.3]
      local:
        - to: Staircase
        - to: East 25 Upper
      locations:
        - name: Hit Switch
          item: Annuna_Mirror_Match_Switch
          req: $can_damage
          time: 0  # simultaneous with movement
      exits:
        - to: Central Pillar
          req: $hover and $hook
          movement: base
    # TODO: Wall Climb-based movement?
    - name: Central Pillar
      coord: [33.1, 24.3]
      local:
        - to: East 25 Lower
      exits:
        - to: Save Point
          req: Annuna_Mirror_Match_Switch
          movement: base
        - to: West 25
          req: Annuna_Mirror_Match_Switch
          movement: base
        - to: Below Switch
          req: $hover and $hook
    #endregion

    #region Below the Stairs
    - name: Plinth
      coord: [33.55, 25.6]
      local:
        - to: East 26 Lower
      locations:
        - name: Item
          item: Big_Flask
          canon: Annuna_Mirror_Match_Flask
          tags: [flask]
      exits:
        - to: East 26 Upper
          req: $hover
          movement: base
          jumps: 1
    - name: Waving Distance
      coord: [33.7, 25.6]
      local:
        - to: East 26 Lower
      locations:
        - name: Shockwave Flask
          item: Big_Flask
          canon: Annuna_Mirror_Match_Flask
          tags: [shockwave]
    - name: East 26 Lower
      coord: [33.95, 25.8]
      local:
        - to: Plinth
          jumps: 1
        - to: Waving Distance
          jumps: 1
      locations:
        - name: Remote Flask
          item: Big_Flask
          canon: Annuna_Mirror_Match_Flask
          req: $boomerang
          tags: [remote_flask]
      exits:
        - to: West Bridge > West 26 Lower
          tags: [xshift]
    - name: East 26 Upper
      coord: [33.95, 25.5]
      local:
        - to: Plinth
        - to: Waving Distance
      exits:
        - to: West Bridge > West 26 Upper
          tags: [xshift]
      hybrid:
        - name: Remote Flask
          item: Big_Flask
          canon: Annuna_Mirror_Match_Flask
          req: $boomerang
          to: East 26 Lower
          tags: [remote_flask]
    #endregion

    #region Lamassu
    #endregion

- name: West Bridge  # MARK: West Bridge
  on_entry: $reset_old_area(^newpos)
  start:
    _doors_opened: false
  map:
    save: [36, 26, 37, 27]
  data:
    save_point: Save Point
  datamap:
    map_spot:
      save: Menu > Kiengir Map > Annuna West Bridge
  spots:
    #region Main Corridor
    - name: West 25 Lower
      coord: [34.05, 24.8]
      local:
        - to: West Outcropping
      exits:
        - to: Mirror Match > East 25 Lower
          tags: [xshift]

    - name: West 25 Upper
      coord: [34.05, 24.3]
    - name: West Outcropping
      coord: [34.35, 24.8]
      local:
        - to: West 25 Lower
        - to: Plinth
          jumps: 1
    - name: Plinth
      coord: [35.475, 24.7]
      local:
        - to: West Outcropping
        - to: East 25 Lower
      locations:
        - name: Item
          item: Nano_Lattice_2
          tags: [standing]
    - name: East 25 Lower
      coord: [36.95, 24.8]
      local:
        - to: Plinth
          jumps: 1
      exits:
        - to: East Bridge > West 25 Lower
          tags: [xshift]
    - name: East 25 Upper
      coord: [36.95, 24.3]
    #endregion

    #region Underneath
    - name: West 26 Lower
      coord: [34.05, 25.8]
    - name: West 26 Upper
      coord: [34.05, 25.5]

    - name: Save Point
      coord: [36.5, 26.7]
    #endregion

    #region Tower
    #endregion

    #region Upper Right
    - name: East 24
      coord: [36.95, 23.55]

    - name: East 22
      coord: [36.95, 21.9]
    - name: Below Tunnel
      coord: [36.75, 21.9]
    - name: Tunnel Wall
      coord: [36.55, 21.8]
      exits:
        - to: Mid Tunnel
          req: $climb
          movement: base
          jumps: 1
    - name: Mid Tunnel
      coord: [36.55, 21.5]
      local:
        - to: East 24
        - to: North
          jumps: 1.5
      exits:
        - to: East 22
          req: $hover
          movement: base
    - name: North
      coord: [36.5, 21.2]
      local:
        - to: Mid Tunnel
      exits:
        - to: West Climb > South
          tags: [ydoor]
    #endregion

- name: East Bridge  # MARK: East Bridge
  on_entry: $reset_old_area(^newpos)
  load:
    _combo: false
  spots:
    #region Main Corridor
    - name: West 25 Lower
      coord: [37.05, 24.8]
      local:
        - to: West Staircase Lower West
          jumps: 1
      exits:
        - to: West Bridge > East 25 Upper
          tags: [xshift]
    - name: West 25 Upper
      coord: [37.05, 24.3]
      local:
        - to: West Under Gap
      exits:
        - to: West Bridge > East 25 Upper
          tags: [xshift]
    - name: West Under Gap
      coord: [37.25, 24.3]
      local:
        - to: West 25 Upper
        - to: West Staircase Upper West
      exits:
        - to: Upper West Gap
          req: $hook
          movement: base
          jumps: 2
        - to: Upper West Gap East
          req: $hook
          movement: base
          jumps: 2
    - name: West Staircase Lower West
      coord: [37.5, 24.7]
      local:
        - to: West 25 Lower
        - to: West Staircase Upper West
          jumps: 3
        - to: West Staircase Upper East
          jumps: 3
        - to: West Staircase Lower East
    - name: West Staircase Lower East
      coord: [37.7, 24.7]
      local:
        - to: West Staircase Lower West
        - to: West Staircase Upper West
          jumps: 3
        - to: West Staircase Upper East
          jumps: 3
        - to: Center Drop-off
    - name: West Staircase Upper West
      coord: [37.5, 24.3]
      local:
        - to: West Under Gap
        - to: West Staircase Upper East
      exits:
        - to: Upper West Gap
          req: $hook
          movement: base
          jumps: 2
        - to: Upper West Gap East
          req: $hook
          movement: base
          jumps: 2
    - name: West Staircase Upper East
      coord: [37.75, 24.3]
      local:
        - to: West Staircase Upper West
        - to: West Staircase Lower West
          jumps_down: 2
        - to: West Staircase Lower East
          jumps_down: 2
        - to: Center Gap West
    - name: Center Drop-off
      coord: [38.15, 24.8]
      local:
        - to: West Staircase Lower East
          jumps: 1
        - to: Center Corridor
    - name: Center Corridor
      coord: [38.45, 24.8]
      local:
        - to: Center Drop-off
    - name: Center Gap West
      coord: [38.3, 24.3]
      local:
        - to: West Staircase Upper East
        - to: Center Corridor
        - to: Center Gap East
      actions:
        - name: Throw Drone into Tower
          req: $can_deploy and Slingshot_Hook and Drone_Hover
          do: $deploy_drone_and_move(`Annuna > East Bridge > Center Corridor`)
          to: Tower Core
          time: 2.5
        # TODO: probably doable with anuman
    - name: Center Gap East
      coord: [38.55, 24.3]
      local:
        - to: Center Gap West
        - to: Center Corridor
      exits:
        - to: Below Gate Button
          req: Annuna_East_Bridge_Gate
          movement: base
      actions:
        - name: Throw Drone into Tower
          req: $can_deploy and Slingshot_Hook and Drone_Hover
          do: $deploy_drone
          to: Tower Core
          time: 3
    - name: Gate Button
      coord: [38.9, 24.1]
      local:
        - to: Below Gate Button
        - to: East Gap West
      locations:
        - name: Switch
          item: Annuna_East_Bridge_Gate
          canon: Annuna_East_Bridge_Gate
          req: $can_damage
          tags: [button]
      exits:
        - to: Gate Button Gap
          req: $climb and $grab
          movement: base
          jumps: 2
    - name: Below Gate Button
      coord: [38.85, 24.3]
      local:
        - to: Gate Button
          jumps: 1
        - to: East Gap West
      locations:
        - name: Switch from Below
          item: Annuna_East_Bridge_Gate
          req: $boomerang
          time: 0.25  # ?
      exits:
        - to: Center Gap East
          req: Annuna_East_Bridge_Gate
          movement: base
    - name: East Gap West
      coord: [39.55, 24.3]
      local:
        - to: Gate Button
          jumps: 1
        - to: Below Gate Button
        - to: East 25 Lower
        - to: East Gap East
    - name: East Gap East
      coord: [39.85, 24.3]
      local:
        - to: East 25 Upper
        - to: East 25 Lower
          thru: [39.8, 24.6]
        - to: East Gap West
      exits:
        - to: Center Corridor
          req: Annuna_East_Bridge_Gate
          movement: base
        
    - name: East 25 Upper
      coord: [39.95, 24.3]
      local:
        - to: East Gap East
      exits:
        - to: Sniper Valley > West 25 Upper
          tags: [xshift]
    - name: East 25 Lower
      coord: [39.95, 24.8]
      exits:
        - to: Sniper Valley > West 25 Lower
          tags: [xshift]
        - to: Center Corridor
          req: Annuna_East_Bridge_Gate
          movement: base
    #endregion

    #region Tower
    - name: Tower Gate
      coord: [38.3, 23.4]
      local:
        - to: Tower Core
        - to: Center Gap East
      locations:
        - name: Tablet
          item: Lament_for_Fools
          tags: [standing]
      exits:
        - to: Upper West Gap East
          req: Annuna_East_Bridge_Gate
          movement: base
        # TODO: jump to Tower top with Anuman+hover?
        - to: Tower West Ledge
          req: $infinite_climb and Annuna_East_Bridge_Gate
          time: 7  # 1s faster than starting from the west?
        - to: Tower West Ledge
          req: $infinite_climb and Annuna_East_Bridge_Gate
          time: 5  # 1s faster than starting from the west?
    - name: Tower Core
      coord: [38.5, 23.5]
      local:
        - to: Center Corridor
        - to: Tower Gate
          jumps: 1
        - to: Tower Opening
        # We could climb and throw drone to the east instead...
    - name: Tower Opening
      coord: [38.65, 23.5]
      local:
        - to: Tower Core
        - to: Gate Button Gap
      actions:
        - name: Climb and Throw Drone
          req: $climb and $can_deploy and Drone_Hover and Slingshot_Hook
          do: $deploy_drone_and_move(`Annuna > East Bridge > Tower Base East`)
          to: Tower East Ledge
          time: 4
    - name: Tower Base East
      coord: [38.7, 23.8]
      local:
        - to: Gate Button Gap
      exits:
        - to: Tower Opening
          req: $grab or $hook
          movement: base
          jumps: 2
    - name: Tower Base West
      coord: [38.2, 23.8]
      local:
        - to: Upper West Gap East
      exits:
        - to: Tower Gate
          req: $climb and Annuna_East_Bridge_Gate
          movement: base
          jumps: 2
    - name: Gate Button Gap
      coord: [38.9, 23.8]
      local:
        - to: Gate Button
        - to: Tower Base East
        - to: Bridge Top East
    - name: Bridge Top East
      coord: [39.6, 23.8]
      local:
        - to: Gate Button Gap
      exits:
        - to: East 24
          req: $grab
          movement: base
          jumps: 2
        - to: East 24
          req: $hook
          movement: base
          jumps: 1

    - name: Tower West Ledge
      coord: [38.25, 22.2]
      local:
        - to: Upper West Gap East
        - to: Upper West Gap
        - to: Tower Mid-air West
          jumps: 2
      exits:
        - to: West 24
          req: $hover
          movement: base
        - to: Tower Secret
          req: ^_combo
          movement: base
          jumps: 1
        - to: Tower Gate
          req: Annuna_East_Bridge_Gate
          movement: base
      actions:
        - name: Enter Combo
          req: not ^_combo
          do: ^_combo = true
          time: 2  # ?
    - name: Tower East Ledge
      coord: [38.65, 22.2]
      local:
        - to: Gate Button Gap
        - to: Bridge Top East
        - to: Tower Mid-air East
          jumps: 2
      exits:
        - to: East 24
          req: $hover
          movement: base
        - to: Tower Secret
          req: ^_combo
          movement: base
          jumps: 1
      actions:
        - name: Enter Combo
          req: not ^_combo
          do: ^_combo = true
          time: 2  # ?
    - name: Tower Secret
      coord: [38.45, 22.15]
      locations:
        - name: Item
          item: Royal_Ring
          tags: [standing]
      exits:
        - to: Tower West Ledge
          req: ^_combo
          movement: base
        - to: Tower East Ledge
          req: ^_combo
          movement: base
        - to: Tower Mid-air West
          req: ^_combo
          movement: base
          jumps: 2
        - to: Tower Mid-air East
          req: ^_combo
          movement: base
          jumps: 2
        - to: Tower Peak
          req: ^_combo and $grab
          movement: base
          jumps: 4
        - to: Tower Peak
          req: ^_combo and $hook
          movement: base
          jumps: 2
      actions:
        - name: Enter Combo
          req: not ^_combo
          do: ^_combo = true
          time: 2  # ?
    - name: Tower Peak
      coord: [38.45, 21.7]
      local:
        - to: Tower Mid-air West
        - to: Tower Mid-air East
        - to: Tower West Ledge
        - to: Tower East Ledge
    - name: Tower Mid-air West
      coord: [38.3, 21.8]
      local:
        - to: Tower West Ledge
      exits:
        - to: Tower Secret
          req: ^_combo
          movement: base
        - to: Tower Peak
          req: $hook
          movement: base
          jumps: 1
        - to: East 22
          req: $hook and $hover
          movement: fast_hover
          jumps: 1
        - to: Sniper Valley > High Ledge
          req: $hook and $hover
          movement: fast_hover
          penalty_tags: [xshift, -fast_hover.1]
    - name: Tower Mid-air East
      coord: [38.6, 21.8]
      local:
        - to: Tower East Ledge
      exits:
        - to: Tower Peak
          req: $hook
          movement: base
          jumps: 1
        - to: Below Cavern
          req: $hook and $hover
          movement: fast_hover
        - to: West Bridge > Below Tunnel
          req: $hook and $hover
          movement: fast_hover
          penalty_tags: [xshift, -fast_hover.1]
        - to: Flung West
          req: $charge
          movement: fling
    #endregion

    #region Upper West
    - name: Upper West Gap
      coord: [37.25, 23.8]
      local:
        - to: Upper West Gap East
        - to: West Under Gap
        - to: West Staircase Upper West
      exits:
        - to: West 24
          req: $hook
          movement: base
          jumps: 1
        - to: West 24
          req: $grab
          movement: base
          jumps: 2
    - name: Upper West Gap East
      coord: [37.5, 23.8]
      local:
        - to: Upper West Gap
        - to: West Under Gap
        - to: West Staircase Upper West
        - to: Upper West Partway East
      exits:
        - to: Tower Gate
          req: $hook and Annuna_East_Bridge_Gate
          movement: base
          jumps: 1
    - name: Upper West Partway East
      coord: [38.05, 23.8]
      local:
        - to: Upper West Gap East
        - to: Tower Base West
      exits:
        - to: Tower Gate
          req: $hook and Annuna_East_Bridge_Gate
          movement: base
          jumps: 1
        - to: Tower Gate
          req: $grab and Annuna_East_Bridge_Gate
          movement: base
          jumps: 2
        - to: Tower West Ledge
          req: $infinite_climb and not Annuna_East_Bridge_Gate
          time: 8
        - to: Tower West Ledge
          req: $infinite_climb and Slingshot_Hook and not Annuna_East_Bridge_Gate
          time: 6
    - name: West 24
      coord: [37.05, 23.55]
      local:
        - to: Upper West Gap
      exits:
        - to: West Bridge > East 24
          tags: [xshift]

    - name: Flung West
      coord: [37.9, 21.85]
      exits:
        - to: Below Cavern
          req: $hover
          movement: fast_hover
        - to: West Bridge > Below Tunnel
          req: $hover
          movement: fast_hover
          penalty_tags: [xshift, -fast_hover.1]
        - to: West Bridge > Tunnel Wall
          req: $hover and Anuman
          movement: fast_hover
          jumps: 1
          penalty_tags: [xshift, -fast_hover.1]
        - to: West 24
          movement: fling
        - to: Upper West Gap
          movement: fling
        - to: West Under Gap
          movement: fling
        - to: West Staircase Upper West
          movement: fling
    - name: West 22
      coord: [37.05, 21.9]
    #endregion

    #region North Cavern
    - name: Cavern Foyer
      coord: [37.45, 21.4]
    - name: Cavern Right
      coord: [37.85, 21.5]
    - name: Cavern Cache
      coord: [37.75, 21.3]
    - name: Below Cavern
      coord: [37.45, 21.9]
    #endregion

    #region Upper East
    - name: Upper East Ledge
      coord: [39.7, 21.85]
      local:
        - to: Gate Button Gap
        - to: East 24
        - to: East 22
          jumps: 1
      exits:
        - to: East 23
          req: $hover
          movement: base
        - to: Tower Opening
          req: $hover
          movement: base
        - to: Tower East Ledge
          req: $hover
          movement: base
        - to: Tower Mid-air East
          req: $hover
          movement: base
          jumps: 1
    - name: East 22
      coord: [39.9, 21.75]
      local:
        - to: Upper East Ledge
      exits:
        - to: Vertical Room > West 22
          tags: [xdoor]
    - name: East 23
      coord: [39.95, 22.35]
      local:
        - to: Gate Button Gap
      exits:
        - to: Sniper Valley > West 23
          tags: [xshift]
    - name: East 24
      coord: [39.95, 23.55]
      local:
        - to: Bridge Top East
      exits:
        - to: Sniper Valley > West 24
          tags: [xshift]
    #endregion

- name: Sniper Valley  # MARK: Sniper Valley
  on_entry: $reset_old_area(^newpos)
  spots:
    #region Lower
    - name: West 25 Upper
      coord: [40.05, 24.3]
      local:
        - to: Bridge Lower Ledge
      exits:
        - to: East Bridge > East 25 Upper
          tags: [xshift]
    - name: West 25 Lower
      coord: [40.05, 24.8]
      local:
        - to: Bridge End
          jumps: 2
      exits:
        - to: East Bridge > East 25 Lower
          tags: [xshift]
    - name: Bridge Lower Ledge
      coord: [40.9, 24.3]
      local:
        - to: West 25 Upper
        - to: Bridge End
    - name: Bridge End
      coord: [41.4, 24.7]
      local:
        - to: West 25 Lower
        - to: Table
          jumps: 2
      locations:
        - name: Health Pickup
          item: Power_Core
          req: $more_refills
          tags: [standing]
      exits:
        - to: Bridge Lower Ledge
          req: $hook
          movement: base
          jumps: 2
        # Doable with Anuman and grab?
    - name: Table
      coord: [42.0, 24.4]
      local:
        - to: Bridge End
        - to: East
      locations:
        - name: Item
          item: Family_Tragedy
          tags: [standing]
    - name: East
      coord: [42.95, 24.6]
      local:
        - to: Table
          jumps: 3
      exits:
        - to: Factory Entrance > West
          tags: [xshift]
    #endregion

    #region Upper
    - name: West 23
      coord: [40.05, 22.35]
      local:
        - to: Bridge Upper Ledge
      exits:
        - to: East Bridge > East 24
          tags: [xshift]
        - to: High Ledge
          req: $hook or $hover
          movement: base
        - to: Cavern Outer Rock West
          req: $mist2
          movement: mist2
          price: 10
    - name: High Ledge
      coord: [40.125, 22.35]
      local:
        - to: West 23
        - to: Bridge Upper Middle
        - to: Cavern Outer Rock West
          jumps: 1
      
    - name: West 24
      coord: [40.05, 23.55]
      local:
        - to: Bridge Upper Middle
      exits:
        - to: East Bridge > East 24
          tags: [xshift]
    - name: Bridge Upper Middle
      coord: [40.4, 23.8]
      local:
        - to: Bridge Upper Ledge
      exits:
        - to: West 24
          req: $grab
          movement: base
          jumps: 2
        - to: West 24
          req: $hook
          movement: base
          jumps: 1
    - name: Bridge Upper Ledge
      coord: [40.9, 23.8]
      local:
        - to: Bridge Upper Middle
        - to: Bridge Lower Ledge
        - to: West 25 Lower
          thru: [40.9, 24.6]
        - to: Bridge End
      # TODO: mist travel up to the cavern?
    #endregion

    #region Cavern
    - name: Cavern Outer Rock West
      coord: [40.25, 22.25]
      local:
        - to: High Ledge
      exits:
        - to: Cavern Outer Rock East
          req: Sniper_Valley_Rock_1
          movement: base
      hybrid:
        - name: Break Outer Wall
          to: Cavern Outer Rock East
          item: Sniper_Valley_Rock_1
          canon: Sniper_Valley_Rock_1
          req: $mist2
          movement: mist2
          price: 130
    - name: Cavern Outer Rock East
      coord: [41.3, 22.25]
      exits:
        - to: Cavern Inner Rock West
          req: ^mode == 'drone'
          movement: base
          jumps: 1
          penalties:
            - when: not Slingshot_Hook
              add: 0.1
        - to: Cavern Outer Rock West
          req: Sniper_Valley_Rock_1
          movement: base
      hybrid:
        - name: Break Outer Wall
          to: Cavern Outer Rock West
          item: Sniper_Valley_Rock_1
          canon: Sniper_Valley_Rock_1
          req: $mist2
          movement: mist2
          price: 130
    - name: Cavern Inner Rock West
      coord: [41.65, 22.225]
      exits:
        - to: Cavern Inner Rock East
          req: ^mode == 'drone' and Sniper_Valley_Rock_2
          movement: base
      hybrid:
        - name: Break Inner Wall
          to: Cavern Inner Rock East
          item: Sniper_Valley_Rock_2
          canon: Sniper_Valley_Rock_2
          req: ^mode == 'drone' and $mist2
          movement: mist2
          price: 30
    - name: Cavern Inner Rock East
      coord: [41.95, 22.225]
      local:
        - to: Cavern Tight Corner
          thru: [42.175, 22.4]
      exits:
        - to: Cavern Inner Rock West
          req: ^mode == 'drone' and Sniper_Valley_Rock_2
          movement: base
      hybrid:
        - name: Break Inner Wall
          to: Cavern Inner Rock West
          item: Sniper_Valley_Rock_2
          canon: Sniper_Valley_Rock_2
          req: ^mode == 'drone' and $mist2
          movement: mist2
          price: 30
    - name: Cavern Tight Corner
      coord: [42.175, 22.55]
      local:
        - to: Cavern Inner Rock East
          thru: [42.175, 22.4]
          jumps: [1, 1]
      exits:
        - to: Cavern Cache
          req: ^mode == 'drone'
          movement: base
    - name: Cavern Cache
      coord: [42.4, 22.7]
      locations:
        - name: Item
          item: Big_Flask
          tags: [flask]
      exits:
        - to: Cavern Tight Corner
          req: ^mode == 'drone'
          movement: base
          jumps: 2
    #endregion

- name: Vertical Room  # MARK: Vertical Room
  on_entry: $reset_old_area(^newpos)
  map:
    save: [40, 19, 41, 20]
  data:
    save_point: Save Point
  datamap:
    map_spot:
      save: Menu > Kiengir Map > Annuna Vertical Room
  start:
    _door_opened: false
  spots:
    #region Lower
    - name: West 22
      coord: [40.1, 21.75]
      local:
        - to: Lower Mid
      exits:
        - to: East Bridge > East 22
          tags: [xdoor]
        - to: Lower Platform 1 Left
          req: $grab
          movement: base
          jumps: 2
        - to: Lower Ledge
          req: $hook
          movement: base
          jumps: 2
        - to: Lower Ledge
          req: $grab and Anuman
          movement: base
          jumps: 2
    - name: Lower Mid
      coord: [40.55, 21.8]
      local:
        - to: West 22
          jumps: 1
        - to: East 22
      exits:
        - to: Lower Platform 1 Right
          req: $grab
          movement: base
          jumps: 2
        - to: Lower Platform 2 Right
          req: $hook
          movement: base
          jumps: 3
    - name: East 22
      coord: [40.95, 21.8]
      local:
        - to: Lower Mid
      exits:
        - to: Lower Hallway > West
          tags: [xshift]

    - name: Lower Platform 1 Left
      coord: [40.3, 21.5]
      local:
        - to: West 22
        - to: Lower Platform 1 Right
        - to: Lower Ledge
          jumps: 1
    - name: Lower Platform 1 Right
      coord: [40.4, 21.5]
      local:
        - to: Lower Platform 1 Left
        - to: Lower Mid
        - to: Lower Platform 2 Right
          thru: [40.55, 21.35]
          jumps: [1, 1]
      exits:
        - to: Lower Platform 2 Right
          req: $grab
          movement: base
          jumps: 2
        - to: Lower Platform 2 Right
          req: $hook
          movement: base
          jumps: 1
    - name: Lower Ledge
      coord: [40.15, 21.35]
      local:
        - to: West 22
        - to: Lower Platform 1 Left
        - to: Lower Platform 2 Left
          jumps: 1
    - name: Lower Platform 2 Left
      coord: [40.2, 21.15]
      local:
        - to: Lower Ledge
        - to: Lower Platform 2 Right
      exits:
        - to: Gate Ledge
          req: $hook
          movement: base
          jumps: 1
        - to: Gate Ledge
          req: $grab and Anuman
          movement: base
          jumps: 2
        - to: Lower Ministair
          req: $climb
          movement: base
          jumps: 3
    - name: Lower Platform 2 Right
      coord: [40.4, 21.15]
      local:
        - to: Lower Platform 2 Left
        - to: Lower Platform 1 Right
        - to: Lower Mid
      exits:
        - to: Gate Ledge
          req: $hook
          movement: base
          jumps: 1
        - to: Gate Ledge
          req: $grab and Anuman
          movement: base
          jumps: 2
        - to: Lower Ministair
          req: $climb
          movement: base
          jumps: 3
    - name: Gate Ledge
      coord: [40.35, 20.75]
      local:
        - to: Lower Ministair
          jumps: 1
        - to: Lower Platform 2 Left
        - to: Lower Platform 2 Right
          thru: [40.3, 20.9]
      exits:
        - to: Plinth
          req: Annuna_Vertical_Room_Gate
          movement: base
          jumps: 1
    - name: Lower Ministair
      coord: [40.2, 20.65]
      local:
        - to: West 21
          jumps: 1
        - to: Gate Ledge
        - to: Lower Platform 2 Left
        - to: Lower Platform 2 Right
    - name: West 21
      coord: [40.05, 20.6]
      local:
        - to: Lower Ministair
      exits:
        - to: Center Save > East
          tags: [xshift]
    #endregion

    #region Mid
    - name: Plinth
      coord: [40.675, 20.6]
      local:
        - to: Gate Button
      locations:
        - name: Item
          item: Boomerang_Upgrade
          tags: [standing]
      exits:
        - to: Gate Ledge
          req: Annuna_Vertical_Room_Gate
          movement: base
        - to: Above Plinth
          req: $hook
          movement: base
          jumps: 2
    - name: Gate Button
      coord: [40.8, 20.7]
      local:
        - to: Plinth
          jumps: 1
        - to: East 21
      locations:
        - name: Hit Button
          item: Annuna_Vertical_Room_Gate
          req: $can_damage
          tags: [button]

    - name: Middle Overhang
      coord: [40.9, 20.6]
      local:
        - to: East 21
      exits:
        # This spot is only accessible with fast hover
        - to: Middle Hallway > Middle
          req: $hook and $hover
          movement: fast_hover
          penalty_tags: [xshift, -fast_hover.1]
    - name: East 21
      coord: [40.95, 20.75]
      local:
        - to: Gate Button
          jumps: 1
      exits:
        - to: Middle Hallway > West
          tags: [xshift]

    - name: West 20
      coord: [40.05, 19.6]
      local:
        - to: Middle Ministair
        - to: Save Point Left
      exits:
        - to: Center Climb > East
          tags: [xshift]
    - name: Middle Ministair
      coord: [40.2, 19.7]
      local:
        - to: West 20
          jumps: 1
        - to: Save Point Left
          jumps: 1
        - to: Above Plinth
        - to: Middle West Shaft
      exits:
        - to: Middle Overhang
          req: $hook and $hover
          movement: fast_hover
    - name: Save Point Left
      coord: [40.3, 19.6]
      local:
        - to: West 20
        - to: Middle Ministair
        - to: Middle West Shaft
        - to: Above Plinth
          thru: [40.3, 19.9]
        - to: Save Point
          jumps: 1
      exits:
        - to: Middle Platform 1
          req: $hook and $hover
          movement: base
          jumps: 3
    - name: Save Point
      coord: [40.5, 19.5]
      local:
        - to: Save Point Left
        - to: Save Point Right
      exits:
        - to: Middle Platform 2
          req: $hook
          movement: base
          jumps: 3
      actions:
        - name: Save
          do: $save
          tags: [save]
    - name: Save Point Right
      coord: [40.7, 19.6]
      local:
        - to: Save Point
          jumps: 1
        - to: East 20
        - to: Above Plinth
          thru: [40.7, 19.85]
        - to: Plinth
        - to: Gate Button
        - to: East 21
    - name: East 20
      coord: [40.95, 19.6]
      local:
        - to: Save Point Right
        - to: Plinth
          thru: [40.8, 19.7]
        - to: Gate Button
          thru: [40.8, 19.7]
        - to: East 21
          thru: [[40.8, 19.7], [40.8, 20.3]]
      exits:
        - to: Upper Hallway > West
          tags: [xshift]
        - to: Middle Platform 1
          req: $hook and $hover
          movement: base
          jumps: 3
    - name: Above Plinth
      coord: [40.6, 20.2]
      local:
        - to: Plinth
        - to: Gate Button
        - to: East 21
        - to: Middle West Shaft
          jumps: 1
      exits:
        - to: Save Point Right
          req: $hook and $hover
          movement: base
          jumps: 3
    - name: Middle West Shaft
      coord: [40.25, 20.0]
      local:
        - to: Above Plinth
      exits:
        - to: Middle Ministair
          req: $climb
          movement: base
          jumps: 2
        - to: Save Point Left
          req: $hook
          movement: base
          jumps: 2

    - name: Middle Platform 1
      coord: [40.575, 18.95]
      local:
        - to: Save Point
        - to: Save Point Left
        - to: Save Point Right
        - to: East 20
    - name: Middle Platform 2
      coord: [40.475, 18.475]
      local:
        - to: Middle Platform 1
        - to: Save Point
        - to: East 20
      exits:
        - to: Upper Doorway
          req: $hook and ^_door_opened
          movement: base
          jumps: 3
    #endregion

    #region Upper
    - name: East 18
      coord: [40.95, 17.6]
      local:
        - to: Upper Platform
          jumps: 1
        - to: Upper Doorway
    - name: Upper Platform
      coord: [40.65, 17.4]
      local:
        - to: Door Switch
        - to: East 18
      exits:
        - to: Near Upper Ledge
          req: $hover
          movement: base
          jumps: 1
        - to: Upper Cache
          req: $hook
          movement: base
          jumps: 2
    - name: Upper Cache
      coord: [40.85, 16.95]
      local:
        - to: East 18
          thru: [40.85, 17.4]
        - to: Upper Platform
        - to: Door Switch
      locations:
        - name: Tablet
          item: Beware_the_Patternmind
          tags: [standing]
      exits:
        - to: West 17
          req: $hover
          movement: base
          jumps: 2
    - name: Upper Doorway
      coord: [40.5, 17.9]
      local:
        - to: Door Switch
          jumps: 2
        - to: East 18
          jumps: 2
      exits:
        - to: Middle Platform 2
          req: ^_door_opened
          movement: base
        - to: Save Point Left
          req: ^_door_opened
          movement: base
        - to: Save Point Right
          req: ^_door_opened
          movement: base
        - to: East 20
          req: ^_door_opened
          movement: base
        - to: Middle Ministair
          req: ^_door_opened
          movement: base
        - to: West 20
          req: ^_door_opened
          movement: base
    - name: Door Switch
      coord: [40.2, 17.6]
      local:
        - to: Upper Doorway
      actions:
        - name: Open Door
          req: $open
          do: ^_door_opened = true
          tags: [hack]
    - name: Near Upper Ledge
      coord: [40.2, 17.15]
      local:
        - to: Door Switch
        - to: Upper Doorway
      exits:
        - to: West 17
          req: $hook
          movement: base
          jumps: 1
    - name: West 17
      coord: [40.1, 16.75]
      local:
        - to: Near Upper Ledge
        - to: Upper Doorway
      exits:
        - to: Upper Cache
          req: $hover
          movement: base
        - to: Upper Platform
          req: $hover
          movement: base
        - to: Upper Save > East
          tags: [xdoor]
    #endregion

- name: Upper Hallway  # MARK: Upper Hallway
  on_entry: $reset_old_area(^newpos)
  spots:
    - name: West
      coord: [41.05, 19.6]
      local:
        - to: Portal Stand
          jumps: 1
      exits:
        - to: Vertical Room > East 20
          tags: [xshift]
    - name: Portal Stand
      coord: [42.5, 19.7]
      local:
        - to: West
          jumps: 1
        - to: Behind Pedestal
    - name: Behind Pedestal
      coord: [42.7, 19.8]
      local:
        - to: Portal Stand
          jumps: 1
      locations:
        - name: Health Pickup
          item: Power_Core
          req: $more_refills
          tags: [standing]

- name: Middle Hallway  # MARK: Middle Hallway
  on_entry: $reset_old_area(^newpos)
  spots:
    - name: West
      coord: [41.05, 20.75]
      local:
        - to: Middle
      exits:
        - to: Vertical Room > East 21
          tags: [xshift]
    - name: Middle
      coord: [42.15, 20.75]
      local:
        - to: West
        - to: East
          jumps: 1
    - name: East
      coord: [42.95, 20.7]
      local:
        - to: Middle
      exits:
        - to: Filter Teleporter > West 21
          tags: [xshift]

- name: Lower Hallway  # MARK: Lower Hallway
  on_entry: $reset_old_area(^newpos)
  spots:
    - name: West
      coord: [41.05, 21.8]
      local:
        - to: Dais Left
          jumps: 2
      exits:
        - to: Vertical Room > East 22
          tags: [xshift]
    - name: Dais Left
      coord: [41.85, 21.55]
      local:
        - to: West
        - to: Dais Right
    - name: Dais Right
      coord: [42.15, 21.55]
      local:
        - to: Dais Left
        - to: East
    - name: East
      coord: [42.95, 21.75]
      local:
        - to: Dais Right
          jumps: 2
      exits:
        - to: Factory Access > West 22
          tags: [xshift]

- name: Factory Entrance  # MARK: Factory Entrance
  on_entry: $reset_old_area(^newpos)
  map: save
  data:
    map_spot: Menu > Kiengir Map > Annuna Factory Entrance
    save_point: Save Point
  spots:
    - name: West
      coord: [43.05, 24.6]
      local:
        - to: Save Point
      exits:
        - to: Sniper Valley > East
          tags: [xshift]
    - name: Save Point
      coord: [43.5, 24.7]
      local:
        - to: West
          jumps: 3
        - to: East
          jumps: 2
      actions:
        - name: Save
          do: $save
          tags: [save]
    - name: East
      coord: [43.9, 24.75]
      local:
        - to: Save Point
          jumps: 2
      exits:
        - to: East Climb > West 25
          tags: [xdoor]

- name: East Climb  # MARK: East Climb
  on_entry: $reset_old_area(^newpos)
  spots:
    - name: West 25
      coord: [44.1, 24.75]
      local:
        - to: West 26
          thru: [44.2, 24.8]
        - to: Platform 3 Left
          jumps: 1
      exits:
        - to: Factory Entrance > East
          tags: [xdoor]
    - name: West 26
      coord: [44.1, 25.65]
      exits:
        - to: Udug Gate > East
          tags: [xdoor]
        - to: Platform 1 Left
          req: $hook
          movement: base
          jumps: 1
    - name: West 24
      coord: [44.05, 23.75]
      local:
        - to: Upper Ledge
          jumps: 1
      exits:
        - to: Factory Access > East 24
          tags: [xshift]

    - name: Platform 1 Left
      coord: [44.3, 25.4]
      local:
        - to: West 26
      exits:
        - to: West 25
          req: $climb and $grab and Anuman
          movement: base
          jumps: 3
        - to: West 25
          req: $infinite_climb and Slingshot_Hook
          movement: base
          jumps: 2
    - name: Platform 2 Left
      coord: [44.55, 25.0]
      local:
        - to: Platform 1 Left
      exits:
        - to: Platform 3 Right
          req: $hook
          movement: base
          jumps: 2
    - name: Platform 3 Left
      coord: [44.35, 24.55]
      local:
        - to: West 25
        - to: West 26
        - to: Platform 3 Right
      exits:
        - to: Platform 4 Left
          req: $hook
          movement: base
          jumps: 2
    - name: Platform 3 Right
      coord: [44.45, 24.55]
      local:
        - to: Platform 3 Left
      exits:
        - to: Platform 4 Left
          req: $hook
          movement: base
          jumps: 2
    - name: Platform 4 Left
      coord: [44.55, 24.15]
      local:
        - to: Platform 3 Left
        - to: Platform 3 Right
      exits:
        - to: Upper Ledge
          req: $hook and $hover
          movement: base
          jumps: 2
    - name: Upper Ledge
      coord: [44.45, 23.7]
      local:
        - to: West 24
        - to: Platform 3 Left

- name: Factory Access  # MARK: Factory Access
  on_entry: $reset_old_area(^newpos)
  spots:
    - name: West 22
      coord: [43.05, 21.75]
      local:
        - to: Staircase Top
        - to: Upper Platform
      exits:
        - to: Lower Hallway > East
          tags: [xshift]
    - name: East 22
      coord: [43.95, 21.75]
      exits:
        - to: East Hideout > West
          tags: [xshift]
        - to: Grate Left
          req: Nanite_Mist
          price: 20
          movement: mist1
        - to: Grate Left
          req: $mist2
          price: 20
          movement: mist2

    - name: East 24
      coord: [43.95, 23.75]
      local:
        - to: Bottom
      exits:
        - to: East Climb > West 24
          tags: [xshift]
    - name: Bottom
      coord: [43.65, 23.75]
      local:
        - to: East 24
      exits:
        - to: Upper Platform
          req: $hook and $hover
          time: 3  # possibly faster if optimized
    - name: Upper Platform
      coord: [43.4, 22.35]
      local:
        - to: Bottom
        - to: East 24
          thru: [43.6, 23.3]
      exits:
        - to: Upper Ledge
          req: $hook
          movement: base
          jumps: 1
        - to: Upper Ledge
          req: $grab
          movement: base
          jumps: 1
        - to: West 22
          req: $hook and $hover
          movement: base
          jumps: 2
    - name: Upper Ledge
      coord: [43.45, 22.0]
      local:
        - to: Staircase Top
          jumps: 2
        - to: East 24
          thru: [[43.425, 22.2], [43.6, 23.3]]
      exits:
        - to: West 22
          req: $hook
          movement: base  # TODO: this is faster than just hover
          jumps: 1
        - to: West 22
          req: $hover
          movement: base
          jumps: 1
    - name: Staircase Top
      coord: [43.65, 21.75]
      local:
        - to: Upper Ledge
        - to: Grate Left
      exits:
        - to: West 22
          req: $hover
          movement: base
    - name: Grate Left
      coord: [43.85, 21.75]
      local:
        - to: Staircase Top
      exits:
        - to: East 22
          req: Nanite_Mist
          price: 20
          movement: mist1
        - to: East 22
          req: $mist2
          price: 20
          movement: mist2

- name: Filter Teleporter  # MARK: Filter Teleporter
  on_entry: $reset_old_area(^newpos)
  map:
    flask: [43, 20, 44, 21]
    tablet: [44, 18, 45, 19]
    spiders: [43, 18, 44, 19]
  datamap:
    map_spot:
      flask: Menu > Kiengir Map > Filter Flask
      tablet: Menu > Kiengir Map > Filter Tablet
      spiders: Menu > Kiengir Map > Filter Spiders
  spots:
    - name: West 21
      coord: [43.05, 20.7]
      local:
        - to: Stair Top
          jumps: 2
      exits:
        - to: Middle Hallway > East
          tags: [xshift]
    - name: Stair Top
      coord: [43.6, 20.4]
      local:
        - to: West 21
        - to: Egg
          jumps: 3
      exits:
        - to: Door Ledge
          req: Anuman
          movement: base
          jumps: 1
        - to: Door Ledge
          req: $grab
          movement: base
          jumps: 2
        - to: Door Ledge
          req: $hook
          movement: base
          jumps: 0.5
        - to: Egg
          req: $hook
          movement: base
          jumps: 2
    - name: Egg
      coord: [44.0, 20.0]
      local:
        - to: Stair Top
      exits:
        - to: Door Ledge
          req: $hook
          movement: base
        - to: East Platform 3
          req: $hook and $hover
          movement: base
          jumps: 3
        - to: Filter > Entrance > Egg
          req: not Hammond_Auth
          time: 13
          tags: [warp]
    - name: Door Ledge
      coord: [43.5, 20.1]
      local:
        - to: Stair Top
        - to: West 21
          thru: [43.5, 20.3]
      locations:
        - name: Shockwave Flask
          canon: Filter_Teleporter_Flask
          item: Flask
          req: $shockwave
          price: 100
          tags: [shockwave]
      exits:
        - to: Egg
          req: $hover
          movement: base
          jumps: 1
        - to: Shaft Bottom
          req: Hammond_Auth
          movement: base
    - name: Shaft Bottom
      coord: [43.3, 20.1]
      locations:
        - name: Flask
          canon: Filter_Teleporter_Flask
          item: Flask
          tags: [flask]
      exits:
        - to: Door Ledge
          req: Hammond_Auth
          movement: base
        - to: Shaft Upper Platform
          req: $grab or $climb
          movement: base
          jumps: 6
        - to: Shaft Upper Platform
          req: $hook
          movement: base
          jumps: 3
    - name: Shaft Upper Platform
      coord: [43.25, 19.15]
      local:
        - to: Shaft Bottom
      exits:
        - to: Shaft Top
          req: $grab or $climb
          movement: base
          jumps: 2
        - to: Shaft Top
          req: $hook
          movement: base
          jumps: 1
        - to: West 19 Mid-flight
          req: $charge
          tags: [charge_time]
    - name: Shaft Top
      coord: [43.15, 18.8]
      local:
        - to: Shaft Upper Platform
        - to: Shaft Bottom
        - to: West 19
      actions:
        - name: Throw Drone
          req: $can_deploy
          do: $deploy_drone
          to: West 19 Mid-flight
          time: 0.5
    - name: West 19 Mid-flight
      coord: [43.05, 18.7]
      local:
        - to: West 19
        - to: Shaft Top
      exits:
        - to: Spider Room > Southwest
          req: $hover
          movement: fast_hover
          penalty_tags: [xshift, -fast_hover.1]
    - name: West 19
      coord: [43.05, 18.8]
      local:
        - to: Shaft Top
      exits:
        - to: Spider Room > East
          tags: [xshift]

    # Northeast side
    - name: East Platform 3
      coord: [44.65, 19.5]
      local:
        - to: Egg
          jumps: 2
      exits:
        - to: East Platform 4
          req: $grab
          movement: base
          jumps: 2
        - to: East Platform 4
          req: $hook
          movement: base
          jumps: 1
    - name: East Platform 4
      coord: [44.6, 19.15]
      local:
        - to: Egg
        - to: East Platform 3
      exits:
        - to: Northeast Ministair
          req: $hover
          movement: base
          jumps: 1
        - to: Northeast Ministair
          req: $climb
          movement: base
          jumps: 2
    - name: Northeast Ministair
      coord: [44.85, 18.8]
      local:
        - to: East Platform 4
        - to: East Platform 3
      exits:
        - to: Northeast Cubby
          req: $hook
          movement: base
          jumps: 2
      actions:
        - name: Throw Drone Up
          req: $can_deploy and Slingshot_Hook
          do: $deploy_drone
          to: Northeast Cubby
          time: 2
    - name: Northeast Cubby
      coord: [44.9, 18.35]
      local:
        - to: Northeast Ministair
        - to: East Platform 4
      locations:
        - name: Tablet
          item: The_Eternal_Arm
          tags: [standing]

- name: Spider Room  # MARK: Spider Room
  on_entry: $reset_old_area(^newpos)
  spots:
    - name: East 
      coord: [42.95, 18.8]
      local:
        - to: Southwest
      exits:
        - to: Filter Teleporter > West 19
          tags: [xshift]
    - name: Southwest
      coord: [41.25, 18.8]
      local:
        - to: East
      exits:
        - to: Center
          req: $hook and $hover
          movement: base
          jumps: 3
    - name: Center
      coord: [42.1, 17.95]
      local:
        - to: Healthy Corner
        - to: Southwest
      exits:
        - to: Northeast Ledge
          req: $hook and $hover
          movement: base
          jumps: 2
    - name: Healthy Corner
      coord: [42.8, 17.95]
      local:
        - to: Center
      locations:
        - name: Health Refill
          item: Power_Core
          req: $more_refills
          tags: [standing]
      exits:
        - to: Northeast Ledge
          req: $hook
          movement: base
          jumps: 2
    - name: Northeast Ledge
      coord: [42.7, 17.5]
      local:
        - to: Healthy Corner
        - to: Center
      exits:
        - to: Upper Seam
          req: $slow
          price: 50
          movement: base
    - name: Upper Seam
      coord: [42.15, 17.5]
      local:
        - to: West
        - to: Northeast Ledge
    - name: West
      coord: [41.05, 17.6]
      local:
        - to: Upper Seam
          jumps: 1
      exits:
        - to: Vertical Room > East 18
          tags: [xshift]

- name: Upper Save  # MARK: Upper Save
  on_entry: $reset_old_area(^newpos)
  map: save
  data:
    map_spot: Menu > Kiengir Map > Annuna Upper
    save_point: Save Point
  spots:
    - name: East
      coord: [39.95, 16.75]
      local:
        - to: Save Point
          jumps: 1
      exits:
        - to: Vertical Room > West 17
          tags: [xdoor]
    - name: Save Point
      coord: [39.5, 16.6]
      local:
        - to: East
        - to: West
      actions:
        - name: Save
          do: $save
          tags: [save]
    - name: West
      coord: [39.05, 16.75]
      local:
        - to: Save Point
          jumps: 1
      exits:
        - to: Lamassu > East 17
          tags: [xshift]

- name: Lamassu  # MARK: Lamassu
  on_entry: $reset_old_area(^newpos)
  data:
    portal_start: Portal Stand
  spots:
    - name: East 17
      coord: [38.95, 16.75]
      local:
        - to: Bottom Hill East
      exits:
        - to: Upper Save > West
          tags: [xshift]
    - name: Bottom Hill East
      coord: [38.7, 16.8]
      local:
        - to: Bottom Hill
          jumps: 1
        - to: East 17
          jumps: 1
      exits:
        - to: Bottom East Ledge
          req: $hook
          movement: base
          jumps: 1
    - name: Bottom Hill
      coord: [38.5, 16.6]
      local:
        - to: Bottom Hill West
        - to: Bottom Hill East
        - to: Bottom East Ledge
          jumps: 1  # ?
      exits:
        - to: Bottom Middle Ledge
          req: $hook
          movement: base
          jumps: 1
    - name: Bottom Hill West
      coord: [38.25, 16.8]
      local:
        - to: West 17
          jumps: 1
        - to: Bottom Hill
          jumps: 2
      exits:
        - to: Hidden Portal > Plinth Right
          req: $hook and $hover
          movement: fast_hover
          jumps: 1
          penalty_tags: [xshift, -fast_hover.1]
    - name: West 17
      coord: [38.05, 16.75]
      local:
        - to: Bottom Hill East
      exits:
        - to: Hidden Portal > East
          tags: [xshift]

    - name: Bottom East Ledge
      coord: [38.7, 16.4]
      local:
        - to: Bottom Hill
        - to: Bottom Hill East
      exits:
        - to: Bottom Middle Ledge
          req: $grab
          movement: base
          jumps: 2
        - to: Bottom Middle Ledge
          req: $hook
          movement: base
          jumps: 1
    - name: Bottom Middle Ledge
      coord: [38.5, 16.2]
      local:
        - to: Bottom East Ledge
        - to: Bottom Hill
        - to: Bottom Hill East
      exits:
        - to: Bottom West Ledge
          req: $grab
          movement: base
          jumps: 2
        - to: Bottom West Ledge
          req: $hook and $hover
          movement: fast_hover
          jumps: 1
        - to: Bottom West Ledge
          req: $hook
          movement: base
          jumps: 1
    - name: Bottom West Ledge
      coord: [38.2, 16.0]
      local:
        - to: Bottom Middle Ledge
        - to: Flat Ground
          jumps: 2
      exits:
        - to: Above Flat Ground
          req: $hook and $hover
          movement: fast_hover
          jumps: 1

    - name: Flat Ground
      coord: [38.75, 15.8]
      local:
        - to: Bottom West Ledge
      exits:
        - to: Ledge By Grate
          req: $climb
          movement: base
          jumps: 2
        - to: Ledge By Grate
          req: $hook
          movement: base
          jumps: 1
        - to: East 16
          req: Nanite_Mist
          price: 40
          movement: base
    - name: Above Flat Ground
      coord: [38.75, 15.7]
      local:
        - to: Flat Ground
        - to: Bottom West Ledge
      exits:
        - to: Ledge By Grate
          req: $hook
          movement: base
          jumps: 1
        - to: East 16
          req: Nanite_Mist
          price: 40
          movement: base

    - name: East 16
      coord: [38.95, 15.8]
      exits:
        - to: Siuna Storage > West
          tags: [xshift]
        - to: Flat Ground
          req: Nanite_Mist
          price: 40
          movement: mist1
        - to: Above Flat Ground
          req: Nanite_Mist
          price: 40
          movement: mist1
        - to: Ledge By Grate
          req: Nanite_Mist
          price: 80
          movement: mist1
    - name: Ledge By Grate
      coord: [38.75, 15.4]
      local:
        - to: Above Flat Ground
      exits:
        - to: East 16
          req: Nanite_Mist
          price: 40
          movement: base
        - to: Lower Brick Ledge
          req: $grab
          movement: base
          jumps: 4
        - to: Lower Brick Ledge
          req: $hook
          movement: base
          jumps: 2

    - name: Lower Brick Ledge
      coord: [38.65, 14.9]
      local:
        - to: Ledge By Grate
        - to: Portal Stand
          jumps: 2
      exits:
        - to: Portal Stand
          req: $hook
          movement: base
          jumps: 1
        - to: Upper Brick Ledge
          req: $hook
          movement: base
          jumps: 3
    - name: Portal Stand
      coord: [38.475, 14.6]
      data:
        flipside: Glacier Breach > South Save > Save Point
      local:
        - to: West 15
        - to: Lower Brick Ledge
      exits:
        - to: Upper Brick Ledge
          req: $hook
          movement: base
          jumps: 2
    - name: West 15
      coord: [38.05, 14.6]
      local:
        - to: Portal Stand
      exits:
        - to: Glacier > Crystals > East
          tags: [xshift]
    - name: Upper Brick Ledge
      coord: [38.75, 14.2]
      local:
        - to: Portal Stand
        - to: Lower Brick Ledge
        - to: Ledge By Grate
      exits:
        - to: East 14
          req: $grab and $climb
          movement: base
          jumps: 3
        - to: East 14
          req: $hook
          movement: base
          jumps: 2
    - name: East 14
      coord: [38.9, 13.65]
      local:
        - to: Upper Brick Ledge
        - to: Portal Stand
        - to: West 15
      exits:
        - to: Glacier > Sea Burial > West 14
          tags: [xdoor]

- name: Hidden Portal  # MARK: Hidden Portal
  on_entry: $reset_old_area(^newpos)
  data:
    portal_start: Portal Stand
    portal_hidden: true
  spots:
    - name: East
      coord: [37.95, 16.75]
      local:
        - to: Plinth Right
          jumps: 1
        - to: Portal Stand
          jumps: 1
      exits:
        - to: Lamassu > West 17
          tags: [xshift]
    - name: Portal Stand
      coord: [37.475, 16.7]
      local:
        - to: Plinth Left
        - to: Plinth Right
    - name: Plinth Right
      coord: [37.55, 16.7]
      local:
        - to: Portal Stand
          jumps: 1
        - to: East
      exits:
        - to: Glacier > Vertical Room > East 17 while hovering
          req: $hook and $hover
          jumps: 1
          movement: fast_hover
          penalty_tags: [xdoor, -fast_hover.2]
    - name: Plinth Left
      coord: [37.4, 16.7]
      local:
        - to: Portal Stand
          jumps: 1
        - to: West
      exits:
        - to: Lamassu > Bottom Hill West
          req: $hook and $hover
          movement: fast_hover
          penalty_tags: [xshift, -fast_hover.1]
    - name: West
      coord: [37.1, 16.75]
      local:
        - to: Portal Stand
          jumps: 1
        - to: Plinth Left
          jumps: 1
      exits:
        - to: Glacier > Vertical Room > East 17
          tags: [xdoor]

- name: Udug Gate  # MARK: Udug Gate
  on_entry: $reset_old_area(^newpos)
  spots:
    - name: East
      coord: [43.9, 25.65]

- name: East Hideout  # MARK: East Hideout
  on_entry: $reset_old_area(^newpos)
  spots:
    - name: West
      coord: [44.05, 21.75]

- name: Center Save  # MARK: Center Save
  on_entry: $reset_old_area(^newpos)
  map: save
  data:
    map_spot: Menu > Kiengir Map > Annuna Center Save
    save_point: Save Point
  spots:
    - name: East
      coord: [39.95, 20.6]
      local:
        - to: Save Point
      exits:
        - to: Vertical Room > West 21
          tags: [xshift]
    - name: Save Point
      coord: [39.5, 20.7]
      local:
        - to: West Floor
        - to: East
          jumps: 2
      actions:
        - name: Save
          do: $save
          tags: [save]
      exits:
        - to: West Catwalk
          req: $hover
          movement: base
          jumps: 1
    - name: West Floor
      coord: [39.05, 20.75]
      local:
        - to: Save Point
          jumps: 2
      exits:
        - to: Twisty Passages > East Floor
          tags: [xshift]
    - name: West Catwalk
      coord: [39.05, 20.5]
      local:
        - to: Save Point
      exits:
        - to: Twisty Passages > East Catwalk
          tags: [xshift]

- name: Twisty Passages  # MARK: Twisty Passages
  on_entry: $reset_old_area(^newpos)
  spots:
    - name: East Floor
      coord: [38.95, 20.75]
      local:
        - to: Bottom Middle
          jumps: 1
      exits:
        - to: Center Save > West Floor
          tags: [xshift]
    - name: East Catwalk
      coord: [38.95, 20.5]
      local:
        - to: East Shaft
          jumps: 1
      exits:
        - to: Center Save > West Catwalk
          tags: [xshift]
    - name: East Shaft
      coord: [38.75, 20.35]
      local:
        - to: East Floor
        - to: East Fork
          jumps: 1
    - name: East Fork
      coord: [38.4, 20.3]
      local:
        - to: Bottom Middle
          jumps_down: 1
        - to: East Shaft
        - to: Northeast C
          jumps: 3
      exits:
        - to: Northeast C
          req: $hook
          movement: base
          jumps: 2
        - to: Northeast C
          req: $grab
          movement: base
          jumps: 2.5
    - name: Bottom Middle
      coord: [38.2, 20.6]
      local:
        - to: Bottom West
        - to: East Floor
      exits:
        - to: Center
          req: $hook
          movement: base
          jumps: 2
        - to: East Fork
          req: $hook
          movement: base
          jumps: 1
    - name: Bottom West
      coord: [37.7, 20.65]
      local:
        - to: Bottom Middle
          jumps: 1
      exits:
        - to: Southwest C
          req: $hook
          movement: base
          jumps: 2

    - name: Center
      coord: [38.0, 20.15]
      local:
        - to: Southwest C
        - to: Bottom Middle
        - to: Northeast C
          jumps: 2
        - to: West Hill Right
          jumps: 3
    - name: Northeast C
      coord: [38.3, 19.75]
      local:
        - to: East Fork
          jumps_down: 2
        - to: West Hill Right
          jumps: 2
        - to: Northeast D
          jumps: 2
      exits:
        - to: West Hill Right
          req: $hook and $hover
          movement: fast_hover
          jumps: 1
        - to: Southwest C
          req: $hook and $hover
          movement: fast_hover
        - to: Northeast D
          req: $hook
          movement: base
          jumps: 0.5
    - name: Northeast D
      coord: [38.4, 19.5]
      local:
        - to: Northeast C
          jumps_down: 1
        - to: East Shaft
          thru: [38.6, 19.6]
        - to: Top
          thru: [38.1, 19.3]
          jumps: [2, 0]
      exits:
        - to: Top
          req: $hook
          movement: base
          jumps: 1
    - name: Top
      coord: [38.0, 19.4]
      local:
        - to: Northeast D
          thru: [38.1, 19.3]
          jumps: [1, 0]
          jumps_down: [0, 1]
        - to: West Hill Right
          thru: [37.9, 19.3]
          jumps: [1, 0]
          jumps_down: [0, 2]
        - to: West Hill Left
          thru: [37.9, 19.3]
          jumps: [1, 0]
          jumps_down: [0, 1]
      locations:
        - name: Tablet
          item: Destruction_Pogrom
          tags: [standing]
    - name: Southwest C
      coord: [37.5, 20.15]
      local:
        - to: Center
        - to: Bottom West
          jumps_down: 1
        - to: Northeast C
          jumps: 3
      exits:
        - to: West Dip
          req: $hook
          movement: base
          jumps: 2
        - to: West Ledge
          req: $hook
          movement: base
          jumps: 2
    - name: West Hill Right
      coord: [37.75, 19.6]
      local:
        - to: West Hill Left
        - to: Top
          thru: [37.9, 19.3]
          jumps: [2, 0]
        - to: Center
          jumps_down: 1
        - to: Northeast C
        - to: Northeast D
          jumps: 3
    - name: West Hill Left
      coord: [38.5, 19.6]
      local:
        - to: West Dip
        - to: West Ledge
        - to: West Hill Right
        - to: Top
          thru: [37.9, 19.3]
          jumps: [2, 0]
      exits:
        - to: Northwest Alcove
          req: $hook
          movement: base
          jumps: 2
    - name: West Dip
      coord: [37.425, 19.85]
      local:
        - to: West Ledge
          jumps: 1
        - to: West Hill Left
          jumps: 2
        - to: Southwest C
          jumps_down: 1
    - name: West Ledge
      coord: [37.35, 19.8]
      local:
        - to: West
        - to: West Dip
        - to: West Hill Right
          jumps: 2
        - to: Southwest C
          jumps_down: 1
    - name: West
      coord: [37.05, 19.9]
      local:
        - to: West Ledge
          jumps: 1
      exits:
        - to: West Climb > East 20
          tags: [xshift]
    - name: Northwest Alcove
      coord: [37.35, 19.2]
      local:
        - to: West Ledge
          thru: [37.4, 19.3]
        - to: West Dip
        - to: West Hill Left
      locations:
        - name: Refill
          item: Power_Core
          req: $more_refills
          tags: [standing]

- name: West Climb  # MARK: West Climb
  on_entry: $reset_old_area(^newpos)
  start:
    _door_opened: false
  spots:
    - name: East 20
      coord: [36.95, 19.9]
      local:
        - to: Platform 1
      exits:
        - to: Twisty Passages > West
          tags: [xshift]
    - name: South
      coord: [36.5, 20.8]
      exits:
        - to: West Bridge > North
          tags: [ydoor]
        - to: Platform 1
          req: $hook and $hover
          movement: base
          jumps: 3
        - to: West Ledge
          req: $grab or Anuman
          movement: base
          jumps: 2
    - name: West Ledge
      coord: [36.1, 20.4]
      local:
        - to: South
      exits:
        - to: Platform 1
          req: $hover
          movement: base
          jumps: 1
    - name: Platform 1
      coord: [36.6, 20.15]
      local:
        - to: South
        - to: East 20
          jumps: 2
      exits:
        - to: Switch Ledge
          req: $hook
          movement: base
          jumps: 1
        - to: Switch Ledge
          req: $climb
          movement: base
          jumps: 3
        - to: Switch Ledge
          req: $grab and Anuman
          movement: base
          jumps: 2
    - name: Switch Ledge
      coord: [36.45, 19.75]
      local:
        - to: South
        - to: Platform 1
      actions:
        - name: Open Door
          req: $unlock4 and not ^_door_opened
          do: ^_door_opened = true
          tags: [hack]
      exits:
        - to: East 20
          req: $hover
          movement: base
        - to: Cache
          req: ^_door_opened
          movement: base
        - to: Platform 2
          req: $hook and $hover
          movement: base
          jumps: 2
    - name: Cache
      coord: [36.2, 19.75]
      locations:
        - name: Item
          item: Eye_Ring
          tags: [standing]
      exits:
        - to: Switch Ledge
          req: ^_door_opened
          movement: base
    - name: Platform 2
      coord: [36.5, 19.15]
      local:
        - to: Switch Ledge
      exits:
        - to: East 19
          req: $hook
          movement: base
          jumps: 1
    - name: Platform 3
      coord: [36.5, 18.4]
      local:
        - to: Platform 2
        - to: East 19
        - to: North
          jumps: 1
    - name: North
      coord: [36.5, 18.2]
      local:
        - to: Platform 3
        - to: East 20
          thru: [36.775, 19.6]
      exits:
        - to: East 19
          req: $hook or $hover
          movement: base
        - to: Glacier > Vertical Room > South
          tags: [ydoor]
    - name: East 19
      coord: [36.95, 18.75]
      local:
        - to: Platform 2
        - to: East 20
          thru: [[36.775, 18.8], [36.775, 19.6]]
        - to: Platform 1
          thru: [36.775, 18.8]
      exits:
        - to: Egg Room > West
          tags: [xshift]
        - to: Platform 3
          req: $hook
          movement: base
          jumps: 1

- name: Egg Room  # MARK: Egg Room
  on_entry: $reset_old_area(^newpos)
  spots:
    - name: West
      coord: [37.05, 18.75]
      local:
        - to: First Egg
          jumps: 4
      exits:
        - to: West Climb > East 19
          tags: [xshift]
        - to: First Egg
          req: $hook
          movement: base
          jumps: 2
    - name: First Egg
      coord: [37.35, 18.3]
      local:
        - to: West
        - to: Second Egg
      exits:
        - to: Second Egg
          req: $hook and $hover
          movement: fast_hover
    - name: Second Egg
      coord: [38.0, 18.3]
      local:
        - to: First Egg
      locations:
        - name: Remote Boomerang Flask
          canon: Egg_Room_Flask
          item: Big_Flask
          req: $remote_boomerang
          time: 10  # ~4 + 5.5
      exits:
        - to: Third Egg
          req: $hook
          movement: base
          jumps: 1
        - to: Third Egg
          req: $hook
          movement: fast_hover
          jumps: 1
    - name: Third Egg
      coord: [38.6, 18.0]
      local:
        - to: Second Egg
      exits:
        - to: East
          req: $hook
          movement: base
          jumps: 2
        - to: Passage Entrance
          req: Nanite_Mist and ^mode == 'drone'
          movement: mist1
          price: 120  # ?
        - to: Passage Entrance
          req: $mist2 and ^mode == 'drone'
          movement: mist2
          price: 60  # ?
        - to: Corner Platform
          req: Anuman
          movement: base
          jumps: 1
    - name: East
      coord: [38.95, 17.6]
      local:
        - to: Third Egg
      exits:
        - to: Center Climb > West
          tags: [xshift]
        - to: Corner Platform
          req: $hover
          movement: base

    - name: Passage Entrance
      coord: [38.15, 17.35]
      local:
        - to: Cache
          jumps: 1
      exits:
        - to: First Egg
          req: ^mode == 'drone'
          movement: base
        - to: Second Egg
          req: ^mode == 'drone'
          movement: base
        - to: Third Egg
          req: $hover
          movement: base
    - name: Cache
      coord: [38.4, 17.35]
      local:
        - to: Passage Entrance
          jumps: 1
      locations:
        - name: Flask
          canon: Egg_Room_Flask
          item: Big_Flask
          tags: [flask]
        - name: Shockwave Flask
          canon: Egg_Room_Flask
          item: Big_Flask
          req: $shockwave
          price: 100
          tags: [shockwave]
    - name: Corner Platform
      coord: [38.475, 17.75]
      local:
        - to: Second Egg
        - to: Third Egg
      locations:
        - name: Shockwave from Outside
          canon: Egg_Room_Flask
          item: Big_Flask
          req: $shockwave
          price: 100
          tags: [shockwave]
        - name: Remote Boomerang Flask
          canon: Egg_Room_Flask
          item: Big_Flask
          req: $remote_boomerang
          time: 9.5  # ~4 + 5.5
      exits:
        - to: East
          req: $hover
          movement: base
          jumps: 1
    # TODO: also the upper left quadrant for the map

- name: Center Climb  # MARK: Center Climb
  on_entry: $reset_old_area(^newpos)
  spots:
    - name: West
      coord: [39.05, 17.6]
      local:
        - to: Upper Platform
      exits:
        - to: Egg Room > East
          tags: [xshift]
    - name: Upper Platform
      coord: [39.6, 18.2]
      local:
        - to: Middle Platform
        - to: East
          thru: [39.8, 19.3]
      exits:
        - to: West
          req: $hook
          movement: base
          jumps: 3
    - name: Middle Platform
      coord: [39.4, 19.0]
      local:
        - to: East
        - to: Lower Platform
      exits:
        - to: Upper Platform
          req: $hook
          movement: base
          jumps: 4
    - name: Lower Platform
      coord: [39.4, 19.4]
      local:
        - to: East
      exits:
        - to: Middle Platform
          req: $hook
          movement: base
          jumps: 2
    - name: East
      coord: [39.95, 19.6]
      exits:
        - to: Vertical Room > West 20
          tags: [xshift]
        - to: Lower Platform
          req: $hook
          movement: base
          jumps: 1
        - to: Middle Platform
          req: Anuman and Slingshot_Hook and Drone_Hover
          movement: base
          jumps: 3

- name: Siuna Storage  # MARK: Siuna Storage
  on_entry: $reset_old_area(^newpos)
  map:
    urn: [39, 14, 40, 15]
  datamap:
    map_spot:
      urn: Menu > Kiengir Map > Nanite Mist
  spots:
    - name: West
      coord: [39.05, 15.8]
      exits:
        - to: Lamassu > East 16
          tags: [xshift]
        - to: Third Platform
          req: $hook
          movement: base
          jumps: 2
    - name: Portal Entry
      coord: [40.525, 15.7]
      local:
        - to: West
          jumps: 2
      exits:
        - to: Third Platform
          req: $hook
          movement: base
          jumps: 2
    - name: Third Platform
      coord: [40.65, 15.2]
      local:
        - to: West
      exits:
        - to: Second Platform
          req: $hook
          movement: base
          jumps: 1
    - name: Second Platform
      coord: [40.55, 14.8]
      local:
        - to: West
        - to: Third Platform
      exits:
        - to: Top Platform
          req: $hook
          movement: base
          jumps: 1
        - to: Upper Ledge
          req: $hook and $hover
          movement: base
          jumps: 2
    - name: Top Platform
      coord: [40.4, 14.4]
      local:
        - to: West
        - to: Upper Ledge
        - to: Second Platform

    - name: Upper Ledge
      coord: [40.1, 14.4]
      local:
        - to: West
        - to: Wall Right
    - name: Wall Right
      coord: [39.85, 14.4]
      local:
        - to: Upper Ledge
      locations:
        - name: Break Wall as Indra
          req: ^mode != 'drone' and Ice_Axe
          canon: Siuna_Storage_Wall
          item: Siuna_Storage_Wall
          time: 0.9
      exits:
        - to: Wall Left
          req: Siuna_Storage_Wall
          movement: base
      hybrid:
        - name: Break Through Wall as Drone
          to: Wall Left
          req: ^mode == 'drone'
          canon: Siuna_Storage_Wall
          item: Siuna_Storage_Wall
          time: 1.75
        - name: Break Through Wall with Mist
          to: Wall Left
          req: Nanite_Mist
          price: 40
          canon: Siuna_Storage_Wall
          item: Siuna_Storage_Wall
          movement: mist1
        - name: Break Through Wall with Mist 2
          to: Wall Left
          req: $mist2
          price: 40
          canon: Siuna_Storage_Wall
          item: Siuna_Storage_Wall
          movement: mist2
    - name: Wall Left
      coord: [39.75, 14.4]
      local:
        - to: Within Range
      locations:
        - name: Break Wall as Indra
          req: ^mode != 'drone' and Ice_Axe
          canon: Siuna_Storage_Wall
          item: Siuna_Storage_Wall
          time: 0.9
        - name: Distant Urn
          req: $boomerang2
          canon: Nanite_Mist
          item: Nanite_Mist
          tags: [remote]
          penalties:
            - when: Anuman
              add: 10.0
      exits:
        - to: Wall Right
          req: Siuna_Storage_Wall
          movement: base
      hybrid:
        - name: Break Through Wall as Drone
          to: Wall Right
          req: ^mode == 'drone'
          canon: Siuna_Storage_Wall
          item: Siuna_Storage_Wall
          time: 1.75
        - name: Break Through Wall with Mist
          to: Wall Right
          req: Nanite_Mist
          price: 40
          canon: Siuna_Storage_Wall
          item: Siuna_Storage_Wall
          movement: mist1
        - name: Break Through Wall with Mist 2
          to: Wall Right
          req: $mist2
          price: 40
          canon: Siuna_Storage_Wall
          item: Siuna_Storage_Wall
          movement: mist2
        - name: Distant Urn Fast Travel
          item: Nanite_Mist
          canon: Nanite_Mist
          req: Fast_Travel and $boomerang2
          to: Menu > Kiengir Map > Nanite Mist
          tags: [cskip]
          penalties:
            - when: Anuman
              add: 10.0
    - name: Within Range
      coord: [39.65, 14.4]
      local:
        - to: Cache
        - to: Wall Left
      locations:
        - name: Remote Urn
          req: $boomerang
          canon: Nanite_Mist
          item: Nanite_Mist
          tags: [remote]
          penalties:
            - when: Anuman
              add: 10.0
      hybrid:
        - name: Remote Urn Fast Travel
          item: Nanite_Mist
          canon: Nanite_Mist
          req: Fast_Travel and $boomerang
          to: Menu > Kiengir Map > Nanite Mist
          tags: [cskip]
          penalties:
            - when: Anuman
              add: 10.0
    - name: Cache
      coord: [39.35, 14.4]
      local:
        - to: Within Range
      locations:
        - name: Urn
          canon: Nanite_Mist
          item: Nanite_Mist
          tags: [urn]
          penalties:
            - when: Anuman
              add: 10.0
      hybrid:
        - name: Urn Collection Skip
          item: Nanite_Mist
          canon: Nanite_Mist
          to: Menu > Warp Only > Kiengir
          tags: [cskip]
          penalties:
            - when: Anuman
              add: 10.0
        - name: Urn Fast Travel
          item: Nanite_Mist
          canon: Nanite_Mist
          req: Fast_Travel
          to: Menu > Kiengir Map > Nanite Mist
          tags: [cskip]
          penalties:
            - when: Anuman
              add: 10.0

#region Apocalypse
- name: Apocalypse Hallway  # MARK: Apocalypse Hallway
  on_entry: $reset_old_area(^newpos)
  spots:
    - name: Lower East
      coord: [43.95, 14.75]
      local:
        - to: East Pillar
          jumps: 1
      exits:
        - to: Glacier > Apocalypse Entry > West 15 Lower
          tags: [xshift]
    - name: Upper East
      coord: [43.95, 14.6]
      local:
        - to: East Pillar
          jumps: 1
      exits:
        - to: Glacier > Apocalypse Entry > West 15 Upper
          tags: [xshift]
        - to: West
          req: $hook and $hover
          movement: fast_hover
          jumps: 2
    - name: East Pillar
      coord: [43.85, 14.55]
      local:
        - to: Upper East
        - to: Lower East
      exits:
        - to: Center Pillar
          req: $grab or $hook
          movement: base
          jumps: 4
    - name: Center Pillar
      coord: [43.0, 14.4]
      local:
        - to: East Pillar
          jumps: 3
      exits:
        - to: West
          req: $grab or $hook
          movement: base
          jumps: 2
    - name: West
      coord: [42.05, 14.55]
      exits:
        - to: Center Pillar
          req: $grab or $hook
          movement: base
          jumps: 2
        - to: Glacier > Apocalypse Entry > Lowest Stair
          req: $hook and $hover
          movement: fast_hover
          jumps: 1
          penalty_tags: [xshift, -fast_hover.1]
        - to: Seals > East 15
          tags: [xshift]

- name: Seals  # MARK: Seals
  on_entry: $reset_old_area(^newpos)
  spots:
    - name: East 15
      coord: [41.95, 14.55]
      local:
        - to: Upper Ledge
      exits:
        - to: Apocalypse Hallway > West
          tags: [xshift]
    - name: Upper Ledge
      coord: [41.6, 15.0]
      local:
        - to: Upper Seal
      exits:
        - to: East 15
          req: $grab
          movement: base
          jumps: 3
        - to: East 15
          req: $hook
          movement: base
          jumps: 2
    - name: Upper Seal
      coord: [41.5, 15.2]
      local:
        - to: Upper Ledge
          jumps: 1
      exits:
        - to: Middle Ledge
          req: not Apocalypse_Bomb
          movement: base
        - to: Lower Seal
          req: not Apocalypse_Bomb
          movement: base
    - name: Middle Ledge
      coord: [41.6, 15.6]
      local:
        - to: Breakable Rock
      exits:
        - to: Lower Seal
          req: not Apocalypse_Bomb
          movement: base
        - to: Upper Seal
          req: $grab
          movement: base
          jumps: 4
        - to: Upper Seal
          req: $hook
          movement: base
          jumps: 2
    - name: Breakable Rock
      coord: [41.8, 15.6]
      local:
        - to: Middle Ledge
      exits:
        - to: Inner Wall
          req: ^mode == 'drone' and Apocalypse_Seals_Wall
          movement: base
      hybrid:
        - name: Break Through Wall
          to: Inner Wall
          req: ^mode == 'drone'
          canon: Apocalypse_Seals_Wall
          item: Apocalypse_Seals_Wall
          time: 2.75  # ?
        - name: Mist Through Wall
          to: Inner Wall
          req: ^mode == 'drone' and Nanite_Mist
          canon: Apocalypse_Seals_Wall
          item: Apocalypse_Seals_Wall
          price: 40
          movement: mist1
        - name: Faster Mist Through Wall
          to: Inner Wall
          req: ^mode == 'drone' and $mist2
          canon: Apocalypse_Seals_Wall
          item: Apocalypse_Seals_Wall
          price: 30
          movement: mist2
    - name: Inner Wall
      coord: [41.9, 15.6]
      exits:
        - to: Final Cache > West
          movement: base
          penalty_tags: [xshift, -base.1]
        - to: Breakable Rock
          req: ^mode == 'drone' and Apocalypse_Seals_Wall
          movement: base
    - name: Lower Seal
      coord: [41.5, 15.9]
      local:
        - to: Lower Ledge
      exits:
        - to: Middle Ledge
          req: $grab
          movement: base
          jumps: 2
        - to: Middle Ledge
          req: $hook
          movement: base
          jumps: 1
        - to: Upper Seal
          req: $hook
          movement: base
          jumps: 3
        - to: East 17 Upper
          req: $hover
          movement: base
    - name: Lower Ledge
      coord: [41.5, 16.1]
      local:
        - to: Lower Seal
          jumps: 1
        - to: East 17 Lower
      exits:
        - to: East 17 Upper
          req: $hover
          movement: base
    - name: East 17 Upper
      coord: [41.95, 16.4]
      exits:
        - to: Final Save > Upper West
          tags: [xshift]
        - to: Lower Ledge
          req: $hover
          movement: base
          jumps: 2
        - to: Lower Ledge
          req: $hook and $hover
          movement: fast_hover
          jumps: 2
    - name: East 17 Lower
      coord: [41.95, 16.75]
      exits:
        - to: Final Save > Lower West
          tags: [xshift]
        - to: Lower Ledge
          req: $grab
          movement: base
          jumps: 4
        - to: Lower Ledge
          req: $hook
          movement: base
          jumps: 2

- name: Final Cache  # MARK: Final Cache
  on_entry: $reset_old_area(^newpos)
  spots:
    - name: West
      coord: [42.1, 15.6]

- name: Final Save  # MARK: Final Save
  on_entry: $reset_old_area(^newpos)
  map: save
  data:
    map_spot: Menu > Kiengir Map > Apocalypse
    save_point: Save Point
  spots:
    - name: Upper West
      coord: [42.05, 16.4]
      exits:
        - to: Seals > East 17 Upper
          tags: [xshift]
        - to: Apocalypse > Northwest Mid-air
          req: $hook and $hover
          movement: fast_hover
          jumps: 1
          penalty_tags: [xshift, -fast_hover.1]
    - name: Lower West
      coord: [42.05, 16.75]
      exits:
        - to: Seals > East 17 Lower
          tags: [xshift]
        - to: Pillar
          req: $grab
          movement: base
          jumps: 3
        - to: Pillar
          req: $hook
          movement: base
          jumps: 1
    - name: Pillar
      coord: [42.35, 16.35]
      local:
        - to: Save Point
        - to: Lower West
      exits:
        - to: Upper West
          req: $hover
          movement: base
    - name: Save Point
      coord: [42.5, 16.55]
      local:
        - to: East
      exits:
        - to: Pillar
          req: $grab
          movement: base
          jumps: 2
        - to: Pillar
          req: $hook
          movement: base
          jumps: 1
        - to: Apocalypse > Northwest Mid-air
          req: $hover
          movement: base
          jumps: 1
          penalty_tags: [xshift, -base.1]
      actions:
        - name: Save
          do: $save
          tags: [save]
    - name: East
      coord: [42.95, 16.75]
      local:
        - to: Save Point
          jumps: 2
      exits:
        - to: Apocalypse > West
          tags: [xshift]
        - to: Upper West
          req: $hook and $hover
          movement: fast_hover
          jumps: 2

- name: Apocalypse  # MARK: Apocalypse
  on_entry: $reset_old_area(^newpos)
  spots:
    - name: West
      coord: [43.05, 16.75]
      local:
        - to: Southwest Switch
        - to: Southwest Capsule
      exits:
        - to: Final Save > East
          tags: [xshift]

    - name: Northwest Mid-air
      coord: [43.35, 16.25]
      exits:
        - to: Northwest Scaffold 2 West
          req: Nanite_Mist
          price: 40
          movement: mist1
        - to: Northwest Scaffold 2 West
          req: $mist2
          price: 40
          movement: mist2

    - name: Northwest Scaffold 2 West
      coord: [43.45, 16.2]
      local:
        - to: Northwest Switch
          jumps: 1
        - to: Center Scaffold West
    - name: Northwest Switch
      coord: [43.7, 15.95]
      local:
        - to: Center Scaffold West
    - name: Center Scaffold West
      coord: [43.85, 16.2]
      hybrid:
        - name: Boss Fight
          item: Apocalypse_Bomb  # TODO: other finales
          canon: Apocalypse_Bomb
          to: Bomb Northwest
          req: Infect and Anuman
          time: 28
        - name: Fill It Up
          item: Apocalypse_Bomb
          canon: Apocalypse_Bomb
          to: Bomb East
          req: Infect and not Anuman
          time: 15
    
    - name: Southwest Switch
      coord: [43.2, 17.35]
      local:
        - to: Southwest Capsule
    - name: Southwest Capsule
      coord: [43.3, 17.35]
      exits:
        - to: West
          req: $grab
          movement: base
          jumps: 4
        - to: West
          req: $hook
          movement: base
          jumps: 2

    - name: Southwest Corner
      coord: [43.125, 17.8]

    - name: Bomb Northwest
      coord: [43.85, 17.35]
      local:
        - to: Southwest Capsule
    - name: Bomb East
      coord: [43.65, 17.6]
      local:
        - to: Southwest Capsule
          jumps: 2
    - name: Bomb
      coord: [43.9, 17.75]
      local:
        - to: Bomb East
          jumps: 1

#endregion
