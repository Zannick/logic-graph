name: Annuna Gorge
short: Annuna

areas:
- name: Mirror Match
  on_entry: $reset_old_area(^newpos)
  map:
    save: [32, 25, 33, 26]
  spots:
    #region Main area
    - name: West 25
      coord: [32.05, 24.8]
      local:
        - to: West Gap
      exits:
        - to: Uhrum > Annuna Corridor > East 25
          tags: [xshift]
    - name: West Gap
      coord: [32.2, 25.0]
      local:
        - to: Save Point
    - name: Save Point
      coord: [23.5, 25.4]
      local:
        - to: Eastward
      locations:
        - name: Fight
          item: Defeat_Indra
          req: Separation
          time: 30  # ?
      actions:
        - name: Save
          req: NOT Separation or Defeat_Indra
          do: $save
    - name: Eastward
      coord: [32.95, 25.4]
      local:
        - to: Save Point
      exits:
        - to: Staircase
          req: NOT Separation or Defeat_Indra
          movement: base
        - to: Staircase
          req: Separation and NOT Defeat_Indra and $mist2
          price: 30
          movement: mist2
    - name: Staircase
      coord: [33.1, 25.4]
      local:
        - to: East 25 Lower
          jumps: 4
      exits:
        - to: Eastward
          req: NOT Separation or Defeat_Indra
          movement: base
        - to: Eastward
          req: Separation and NOT Defeat_Indra and $mist2
          price: 30
          movement: mist2
    - name: East 25 Lower
      coord: [33.95, 24.8]
      local:
        - to: Staircase
      exits:
        - to: West Bridge > West 25 Lower
          tags: [xshift]
    #endregion

    #region Upper Area
    - name: East 25 Upper
      coord: [33.95, 24.3]
      local:
        - to: Below Switch
      exits:
        - to: West Bridge > West 25 Upper
          tags: [xshift]
    - name: Below Switch
      coord: [33.6, 24.3]
      local:
        - to: Staircase
        - to: East 25 Upper
      locations:
        - name: Hit Switch
          item: Annuna_Mirror_Match_Switch
          req: $can_damage
          time: 0  # simultaneous with movement
      exits:
        - to: Central Pillar
          req: $hover and $hook
          movement: base
    # TODO: Wall Climb-based movement?
    - name: Central Pillar
      coord: [33.1, 24.3]
      local:
        - to: East 25 Lower
      exits:
        - to: Save Point
          req: Annuna_Mirror_Match_Switch
          movement: base
        - to: West 25
          req: Annuna_Mirror_Match_Switch
          movement: base
        - to: Below Switch
          req: $hover and $hook
    #endregion

    #region Below the Stairs
    - name: Plinth
      coord: [33.55, 25.6]
      local:
        - to: East 26 Lower
      locations:
        - name: Item
          item: Big_Flask
          canon: Annuna_Mirror_Match_Flask
          tags: [flask]
      exits:
        - to: East 26 Upper
          req: $hover
          movement: base
          jumps: 1
    - name: Waving Distance
      coord: [33.7, 25.6]
      local:
        - to: East 26 Lower
      locations:
        - name: Shockwave Flask
          item: Big_Flask
          canon: Annuna_Mirror_Match_Flask
          tags: [shockwave]
    - name: East 26 Lower
      coord: [33.95, 25.8]
      local:
        - to: Plinth
          jumps: 1
        - to: Waving Distance
          jumps: 1
      locations:
        - name: Remote Flask
          item: Big_Flask
          canon: Annuna_Mirror_Match_Flask
          req: $boomerang
          tags: [remote_flask]
      exits:
        - to: West Bridge > West 26 Lower
          tags: [xshift]
    - name: East 26 Upper
      coord: [33.95, 25.5]
      local:
        - to: Plinth
        - to: Waving Distance
      exits:
        - to: West Bridge > West 26 Upper
          tags: [xshift]
      hybrid:
        - name: Remote Flask
          item: Big_Flask
          canon: Annuna_Mirror_Match_Flask
          req: $boomerang
          to: East 26 Lower
          tags: [remote_flask]
          item_time: 0
    #endregion

    #region Lamassu
    #endregion

- name: West Bridge
  on_entry: $reset_old_area(^newpos)
  start:
    _doors_opened: false
  map:
    save: [36, 26, 27, 27]
  spots:
    #region Main Corridor
    - name: West 25 Lower
      coord: [34.05, 24.8]
      local:
        - to: West Outcropping
      exits:
        - to: Mirror Match > East 25 Lower
          tags: [xshift]

    - name: West 25 Upper
      coord: [34.05, 24.3]
    - name: West Outcropping
      coord: [34.35, 24.8]
      local:
        - to: West 25 Lower
        - to: Plinth
          jumps: 1
    - name: Plinth
      coord: [35.475, 24.7]
      local:
        - to: West Outcropping
        - to: East 25 Lower
      locations:
        - name: Item
          item: Nano_Lattice_2
          tags: [standing]
    - name: East 25 Lower
      coord: [36.95, 24.8]
      local:
        - to: Plinth
          jumps: 1
      exits:
        - to: East Bridge > West 25 Lower
          tags: [xshift]
    - name: East 25 Upper
      coord: [36.95, 24.3]
    #endregion

    #region Underneath
    - name: West 26 Lower
      coord: [34.05, 25.8]
    - name: West 26 Upper
      coord: [34.05, 25.5]
    #endregion

    #region Tower
    #endregion

    #region Upper Right
    - name: East 24
      coord: [36.95, 23.55]

    - name: East 22
      coord: [36.95, 21.9]
    - name: Below Tunnel
      coord: [36.75, 21.9]
    #endregion

- name: East Bridge
  on_entry: $reset_old_area(^newpos)
  load:
    _combo: false
  spots:
    #region Main Corridor
    - name: West 25 Lower
      coord: [37.05, 24.8]
      local:
        - to: West Staircase Lower West
          jumps: 1
      exits:
        - to: West Bridge > East 25 Upper
          tags: [xshift]
    - name: West 25 Upper
      coord: [37.05, 24.3]
      local:
        - to: West Under Gap
      exits:
        - to: West Bridge > East 25 Upper
          tags: [xshift]
    - name: West Under Gap
      coord: [37.25, 24.3]
      local:
        - to: West 25 Upper
        - to: West Staircase Upper West
      exits:
        - to: Upper West Gap
          req: $hook
          movement: base
          jumps: 2
        - to: Upper West Gap East
          req: $hook
          movement: base
          jumps: 2
    - name: West Staircase Lower West
      coord: [37.5, 24.7]
      local:
        - to: West 25 Lower
        - to: West Staircase Upper West
          jumps: 3
        - to: West Staircase Upper East
          jumps: 3
        - to: West Staircase Lower East
    - name: West Staircase Lower East
      coord: [37.7, 24.7]
      local:
        - to: West Staircase Lower West
        - to: West Staircase Upper West
          jumps: 3
        - to: West Staircase Upper East
          jumps: 3
        - to: Center Drop-off
    - name: West Staircase Upper West
      coord: [37.5, 24.3]
      local:
        - to: West Under Gap
        - to: West Staircase Upper East
      exits:
        - to: Upper West Gap
          req: $hook
          movement: base
          jumps: 2
        - to: Upper West Gap East
          req: $hook
          movement: base
          jumps: 2
    - name: West Staircase Upper East
      coord: [37.75, 24.3]
      local:
        - to: West Staircase Upper West
        - to: West Staircase Lower West
          jumps_down: 2
        - to: West Staircase Lower East
          jumps_down: 2
        - to: Center Gap West
    - name: Center Drop-off
      coord: [38.15, 24.8]
      local:
        - to: West Staircase Lower East
          jumps: 1
        - to: Center Corridor
    - name: Center Corridor
      coord: [38.45, 24.8]
      local:
        - to: Center Drop-off
    - name: Center Gap West
      coord: [38.3, 24.3]
      local:
        - to: West Staircase Upper East
        - to: Center Corridor
        - to: Center Gap East
      actions:
        - name: Throw Drone into Tower
          req: $can_deploy and Slingshot_Hook and Drone_Hover
          do: $deploy_drone_and_move(`Annuna > East Bridge > Center Corridor`)
          to: Tower Core
          time: 2.5
        # TODO: probably doable with anuman
    - name: Center Gap East
      coord: [38.55, 24.3]
      local:
        - to: Center Gap West
        - to: Center Corridor
      exits:
        - to: Below Gate Button
          req: Annuna_East_Bridge_Gate
          movement: base
      actions:
        - name: Throw Drone into Tower
          req: $can_deploy and Slingshot_Hook and Drone_Hover
          do: $deploy_drone
          to: Tower Core
          time: 3
    - name: Gate Button
      coord: [38.9, 24.1]
      local:
        - to: Below Gate Button
        - to: East Gap West
      locations:
        - name: Switch
          item: Annuna_East_Bridge_Gate
          canon: Annuna_East_Bridge_Gate
          req: $can_damage
          time: 0
      exits:
        - to: Gate Button Gap
          req: $climb and $grab
          movement: base
          jumps: 2
    - name: Below Gate Button
      coord: [38.85, 24.3]
      local:
        - to: Gate Button
          jumps: 1
        - to: East Gap West
      locations:
        - name: Switch from Below
          item: Annuna_East_Bridge_Gate
          req: $boomerang
          time: 0.25  # ?
      exits:
        - to: Center Gap East
          req: Annuna_East_Bridge_Gate
          movement: base
    - name: East Gap West
      coord: [39.55, 24.3]
      local:
        - to: Gate Button
          jumps: 1
        - to: Below Gate Button
        - to: East 25 Lower
        - to: East Gap East
    - name: East Gap East
      coord: [39.85, 24.3]
      local:
        - to: East 25 Upper
        - to: East 25 Lower
          thru: [39.8, 24.6]
        - to: East Gap West
      exits:
        - to: Center Corridor
          req: Annuna_East_Bridge_Gate
          movement: base
        
    - name: East 25 Upper
      coord: [39.95, 24.3]
      local:
        - to: East Gap East
      exits:
        - to: Sniper Valley > West 25 Upper
          tags: [xshift]
    - name: East 25 Lower
      coord: [39.95, 24.8]
      exits:
        - to: Sniper Valley > West 25 Lower
          tags: [xshift]
        - to: Center Corridor
          req: Annuna_East_Bridge_Gate
          movement: base
    #endregion

    #region Tower
    - name: Tower Gate
      coord: [38.3, 23.4]
      local:
        - to: Tower Core
        - to: Center Gap East
      locations:
        - name: Tablet
          item: Lament_for_Fools
          tags: [standing]
      exits:
        - to: Upper West Gap East
          req: Annuna_East_Bridge_Gate
          movement: base
        # TODO: jump to Tower top with Anuman+hover?
    - name: Tower Core
      coord: [38.5, 23.5]
      local:
        - to: Center Corridor
        - to: Tower Gate
          jumps: 1
        - to: Tower Opening
        # We could climb and throw drone to the east instead...
    - name: Tower Opening
      coord: [38.65, 23.5]
      local:
        - to: Tower Core
        - to: Gate Button Gap
      actions:
        - name: Climb and Throw Drone
          req: $climb and $can_deploy and Hover and Slingshot_Hook
          do: $deploy_drone_and_move(`Annuna > East Tower > Tower Base East`)
          to: Tower East Ledge
          time: 4
    - name: Tower Base East
      coord: [38.7, 23.8]
      local:
        - to: Gate Button Gap
      exits:
        - to: Tower Opening
          req: $grab or $hook
          movement: base
          jumps: 2
    - name: Tower Base West
      coord: [38.2, 23.8]
      local:
        - to: Upper West Gap East
      exits:
        - to: Tower Gate
          req: $climb and Annuna_East_Bridge_Gate
          movement: base
          jumps: 2
    - name: Gate Button Gap
      coord: [38.9, 23.8]
      local:
        - to: Gate Button
        - to: Tower Base East
        - to: Bridge Top East
    - name: Bridge Top East
      coord: [39.6, 23.8]
      local:
        - to: Gate Button Gap
      exits:
        - to: East 24
          req: $grab
          movement: base
          jumps: 2
        - to: East 24
          req: $hook
          movement: base
          jumps: 1

    - name: Tower West Ledge
      coord: [38.25, 22.2]
      local:
        - to: Upper West Gap East
        - to: Upper West Gap
        - to: Tower Mid-air West
          jumps: 2
      exits:
        - to: West 24
          req: $hover
          movement: base
        - to: Tower Secret
          req: ^_combo
          movement: base
          jumps: 1
      actions:
        - name: Enter Combo
          req: not ^_combo
          do: ^_combo = true
          time: 2  # ?
    - name: Tower East Ledge
      coord: [38.65, 22.2]
      local:
        - to: Gate Button Gap
        - to: Bridge Top East
        - to: Tower Mid-air East
          jumps: 2
      exits:
        - to: East 24
          req: $hover
          movement: base
        - to: Tower Secret
          req: ^_combo
          movement: base
          jumps: 1
      actions:
        - name: Enter Combo
          req: not ^_combo
          do: ^_combo = true
          time: 2  # ?
    - name: Tower Secret
      coord: [38.45, 22.15]
      locations:
        - name: Item
          item: Royal_Ring
          tags: [standing]
      exits:
        - to: Tower West Ledge
          req: ^_combo
          movement: base
        - to: Tower East Ledge
          req: ^_combo
          movement: base
        - to: Tower Mid-air West
          req: ^_combo
          movement: base
          jumps: 2
        - to: Tower Mid-air East
          req: ^_combo
          movement: base
          jumps: 2
        - to: Tower Peak
          req: ^_combo and $grab
          movement: base
          jumps: 4
        - to: Tower Peak
          req: ^_combo and $hook
          movement: base
          jumps: 2
      actions:
        - name: Enter Combo
          req: not ^_combo
          do: ^_combo = true
          time: 2  # ?
    - name: Tower Peak
      coord: [38.45, 21.7]
      local:
        - to: Tower Mid-air West
        - to: Tower Mid-air East
        - to: Tower West Ledge
        - to: Tower East Ledge
    - name: Tower Mid-air West
      coord: [38.3, 21.8]
      local:
        - to: Tower West Ledge
      exits:
        - to: Tower Secret
          req: ^_combo
          movement: base
        - to: Tower Peak
          req: $hook
          movement: base
          jumps: 1
        - to: East 22
          req: $hook and $hover
          movement: fast_hover
          jumps: 1
        - to: Sniper Valley > High Ledge
          req: $hook and $hover
          movement: fast_hover
          penalty_tags: [xshift, -fast_hover.1]
    - name: Tower Mid-air East
      coord: [38.6, 21.8]
      local:
        - to: Tower East Ledge
      exits:
        - to: Tower Peak
          req: $hook
          movement: base
          jumps: 1
        - to: Below Cavern
          req: $hook and $hover
          movement: fast_hover
        - to: West Bridge > Below Tunnel
          req: $hook and $hover
          movement: fast_hover
          penalty_tags: [xshift, -fast_hover.1]
    #endregion

    #region Upper West
    - name: Upper West Gap
      coord: [37.25, 23.8]
      local:
        - to: Upper West Gap East
        - to: West Under Gap
        - to: West Staircase Upper West
      exits:
        - to: West 24
          req: $hook
          movement: base
          jumps: 1
        - to: West 24
          req: $grab
          movement: base
          jumps: 2
    - name: Upper West Gap East
      coord: [37.5, 23.8]
      local:
        - to: Upper West Gap
        - to: West Under Gap
        - to: West Staircase Upper West
        - to: Tower Base West
      exits:
        - to: Tower Gate
          req: $hook and Annuna_East_Bridge_Gate
          movement: base
          jumps: 1
    - name: West 24
      coord: [37.05, 23.55]
      local:
        - to: Upper West Gap
      exits:
        - to: West Bridge > East 24
          tags: [xshift]

    - name: Cavern Foyer
      coord: [37.45, 21.4]
    - name: Cavern Right
      coord: [37.85, 21.5]
    - name: Cavern Cache
      coord: [37.75, 21.3]
    - name: Below Cavern
      coord: [37.45, 21.9]
    - name: West 22
      coord: [37.05, 21.9]
    #endregion

    #region Upper East
    - name: Upper East Ledge
      coord: [39.7, 21.85]
      local:
        - to: Gate Button Gap
        - to: East 24
        - to: East 22
          jumps: 1
      exits:
        - to: East 23
          req: $hover
          movement: base
        - to: Tower Opening
          req: $hover
          movement: base
        - to: Tower East Ledge
          req: $hover
          movement: base
        - to: Tower Mid-air East
          req: $hover
          movement: base
          jumps: 1
    - name: East 22
      coord: [39.9, 21.75]
      local:
        - to: Upper East Ledge
      exits:
        - to: Vertical Room > West 22
          tags: [xdoor]
    - name: East 23
      coord: [39.95, 22.35]
      local:
        - to: Gate Button Gap
      exits:
        - to: Sniper Valley > West 23
          tags: [xshift]
    - name: East 24
      coord: [39.95, 23.55]
      local:
        - to: Bridge Top East
      exits:
        - to: Sniper Valley > West 24
          tags: [xshift]
    #endregion

- name: Sniper Valley
  on_entry: $reset_old_area(^newpos)
  spots:
    #region Lower
    - name: West 25 Upper
      coord: [40.05, 24.3]
      local:
        - to: Bridge Lower Ledge
      exits:
        - to: East Bridge > East 25 Upper
          tags: [xshift]
    - name: West 25 Lower
      coord: [40.05, 24.8]
      local:
        - to: Bridge End
          jumps: 2
      exits:
        - to: East Bridge > East 25 Lower
          tags: [xshift]
    - name: Bridge Lower Ledge
      coord: [40.9, 24.3]
      local:
        - to: West 25 Upper
        - to: Bridge End
    - name: Bridge End
      coord: [41.4, 24.7]
      local:
        - to: West 25 Lower
        - to: Table
          jumps: 2
      locations:
        - name: Health Pickup
          item: Power_Core
          req: $more_refills
          tags: [standing]
      exits:
        - to: Bridge Lower Ledge
          req: $hook
          movement: base
          jumps: 2
        # Doable with Anuman and grab?
    - name: Table
      coord: [42.0, 24.4]
      local:
        - to: Bridge End
        - to: East
      locations:
        - name: Item
          item: Family_Tragedy
          tags: [standing]
    - name: East
      coord: [42.95, 24.6]
      local:
        - to: Table
          jumps: 3
      exits:
        - to: Factory Entrance > West
          tags: [xshift]
    #endregion

    #region Upper
    - name: West 23
      coord: [40.05, 22.35]
      local:
        - to: Bridge Upper Ledge
      exits:
        - to: East Bridge > East 24
          tags: [xshift]
        - to: High Ledge
          req: $hook or $hover
          movement: base
        - to: Cavern Outer Rock West
          req: $mist2
          movement: mist2
          price: 10
    - name: High Ledge
      coord: [40.125, 22.35]
      local:
        - to: West 23
        - to: Bridge Upper Middle
        - to: Cavern Outer Rock West
          jumps: 1
      
    - name: West 24
      coord: [40.05, 23.55]
      local:
        - to: Bridge Upper Middle
      exits:
        - to: East Bridge > East 24
          tags: [xshift]
    - name: Bridge Upper Middle
      coord: [40.4, 23.8]
      local:
        - to: Bridge Upper Ledge
      exits:
        - to: West 24
          req: $grab
          movement: base
          jumps: 2
        - to: West 24
          req: $hook
          movement: base
          jumps: 1
    - name: Bridge Upper Ledge
      coord: [40.9, 23.8]
      local:
        - to: Bridge Upper Middle
        - to: Bridge Lower Ledge
        - to: West 25 Lower
          thru: [40.9, 24.6]
        - to: Bridge End
      # TODO: mist travel up to the cavern?
    #endregion

    #region Cavern
    - name: Cavern Outer Rock West
      coord: [40.25, 22.25]
      local:
        - to: High Ledge
      exits:
        - to: Cavern Outer Rock East
          req: Sniper_Valley_Rock_1
          movement: base
      hybrid:
        - name: Break Outer Wall
          to: Cavern Outer Rock East
          item: Sniper_Valley_Rock_1
          canon: Sniper_Valley_Rock_1
          req: $mist2
          movement: mist2
          price: 130
          item_time: 0
    - name: Cavern Outer Rock East
      coord: [41.3, 22.25]
      exits:
        - to: Cavern Inner Rock West
          req: ^mode == 'drone'
          movement: base
          jumps: 1
          penalties:
            - when: not Slingshot_Hook
              add: 0.1
        - to: Cavern Outer Rock West
          req: Sniper_Valley_Rock_1
          movement: base
      hybrid:
        - name: Break Outer Wall
          to: Cavern Outer Rock West
          item: Sniper_Valley_Rock_1
          canon: Sniper_Valley_Rock_1
          req: $mist2
          movement: mist2
          price: 130
          item_time: 0
    - name: Cavern Inner Rock West
      coord: [41.65, 22.225]
      exits:
        - to: Cavern Inner Rock East
          req: ^mode == 'drone' and Sniper_Valley_Rock_2
          movement: base
      hybrid:
        - name: Break Inner Wall
          to: Cavern Inner Rock East
          item: Sniper_Valley_Rock_2
          canon: Sniper_Valley_Rock_2
          req: ^mode == 'drone' and $mist2
          movement: mist2
          price: 30
          item_time: 0
    - name: Cavern Inner Rock East
      coord: [41.95, 22.225]
      local:
        - to: Cavern Tight Corner
          thru: [42.175, 22.4]
      exits:
        - to: Cavern Inner Rock West
          req: ^mode == 'drone' and Sniper_Valley_Rock_2
          movement: base
      hybrid:
        - name: Break Inner Wall
          to: Cavern Inner Rock West
          item: Sniper_Valley_Rock_2
          canon: Sniper_Valley_Rock_2
          req: ^mode == 'drone' and $mist2
          movement: mist2
          price: 30
          item_time: 0
    - name: Cavern Tight Corner
      coord: [42.175, 22.55]
      local:
        - to: Cavern Inner Rock East
          thru: [42.175, 22.4]
          jumps: [1, 1]
      exits:
        - to: Cavern Cache
          req: ^mode == 'drone'
          movement: base
    - name: Cavern Cache
      coord: [42.4, 22.7]
      locations:
        - name: Item
          item: Big_Flask
          tags: [flask]
      exits:
        - to: Cavern Tight Corner
          req: ^mode == 'drone'
          movement: base
          jumps: 2
    #endregion

- name: Vertical Room
  on_entry: $reset_old_area(^newpos)
  map:
    save: [40, 19, 41, 20]
  spots:
    #region Lower
    - name: West 22
      coord: [40.1, 21.75]
    - name: Lower Mid
      coord: [40.55, 21.8]
    - name: East 22
      coord: [40.95, 21.8]
    #endregion

    #region Mid
    #endregion

    #region Upper
    #endregion

- name: Lower Hallway
  on_entry: $reset_old_area(^newpos)
  spots:
    - name: West
      coord: [41.05, 21.8]
      local:
        - to: Dais Left
          jumps: 2
      exits:
        - to: Vertical Room > East 22
          tags: [xshift]
    - name: Dais Left
      coord: [41.85, 21.55]
      local:
        - to: West
        - to: Dais Right
    - name: Dais Right
      coord: [42.15, 21.55]
      local:
        - to: Dais Left
        - to: East
    - name: East
      coord: [42.95, 21.75]
      local:
        - to: Dais Right
          jumps: 2
      exits:
        - to: Factory Access > West 22
          tags: [xshift]

- name: Factory Entrance
  on_entry: $reset_old_area(^newpos)
  map: save
  spots:
    - name: West
      coord: [43.05, 24.6]
      local:
        - to: Save Point
      exits:
        - to: Sniper Valley > East
          tags: [xshift]
    - name: Save Point
      coord: [43.5, 24.7]
      local:
        - to: West
          jumps: 3
        - to: East
          jumps: 2
      actions:
        - name: Save
          do: $save
          tags: [save]
    - name: East
      coord: [43.9, 24.75]
      local:
        - to: Save Point
          jumps: 2
      exits:
        - to: East Climb > West 25
          tags: [xdoor]

- name: East Climb
  on_entry: $reset_old_area(^newpos)
  spots:
    - name: West 25
      coord: [44.1, 24.75]

- name: Factory Access
  on_entry: $reset_old_area(^newpos)
  spots:
    - name: West 22
      coord: [43.05, 21.75]
