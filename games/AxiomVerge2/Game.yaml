name: Axiom Verge 2

context:
  energy:
    max: 450
  flasks:
    max: 100
  refills:
    max: 4
  mode:
    opts: [Indra, drone]
    default: Indra

start:
  position: Antarctica > West > Helipad
  save: Antarctica > West > Helipad
  # By itself 'None' would be interpreted as a string,
  # which becomes its own independent per-variable enum type.
  indra: SpotId::None
  last: SpotId::None
  # This should be a load effect? prev_area = $get_area(^position) ?
  prev_area: Antarctica > West

data:
  breach: false
  water: false
  flipside: SpotId::None


# TODO: the win condition should be an item Victory,
# whose requirement is $objective corresponding to the current objective.
# otherwise it gets weird, thinking we can beat the final boss and escape and then go get
# the last items? This way simulates requiring the Victory item be last.
objectives:
  Start: "[Remote_Drone]"
  # Greedy search will have a problem with purchases if there are insufficient funds;
  # it will never consider skipping what's available and may be unable to buy something
  # necessary.
  Progress%: "[Remote_Drone, Shockwave, Power_Matrix, Wall_Climb, Flask{5}, $all_notes]"

movements:
  default:  # the slowest movement is in water
    # a grid line = 1 unit. each minimap pixel is about .1 unit
    x: .222  # about 4.5s per grid x-unit underwater if we don't have liru
    fall: 1
    jump: 1  # can vary with jump height, so take a rough estimate of usual
    jump_down: .1
  # There should probably be a way to encode this "water" movement penalty
  # as a feature of the environment rather than use a movement type that relies
  # on a context var we only use overrides for
  general:
    x: .285  # about 3.5s per grid x-unit
    jump: .6  # can vary with jump height, so take a rough estimate of usual
    req: not ^water
  water:
    x: .285
    req: Underwater_Movement
  # TODO: mist movement costs 30 energy/s
  mist_upgraded:
    req: Mist_Upgrade
    free: .225  # this is an estimate
  # TODO: drone slingshot+hover is faster x movement but is pretty circumstantial
  # *and* limited
  # But with just throw + hover, can cover about 2.5 in ~6s / 1 in 2.5s
  # aka ~.4-.416 speed in one direction for around 6s max
  # TODO: anuman "movement" of constantly changing form?


time:
  default: 1
  urn: 5.5
  flask: 5.5
  # when grabbing the urn/flask with the boomerang over x distance
  # the upgraded boomerang has a longer reach but approximately the same speed as indra
  # so there's little difference
  remote_urn: 6.5
  remote_flask: 6.5
  # when grabbing the urn/flask with the boomerang while falling or otherwise closer
  nearby_urn: 6
  nearby_flask: 6
  shockwave: 3.5  # even when shockwaving flasks and urns? at least 1
  xshift: 1.35  # sometimes 1.2, sometimes 1.5?
  # When areas use connecting doors
  xdoor: 1.6  # up to 2??
  ydoor: 1.6
  # Doors leading inside/outside
  interior: 0.75
  exterior: 0.75
  tent: 0.25
  cave: 0.25
  # item is freestanding -> can be picked up with no delay
  standing: 0
  # spots are technically the same, but in different areas to partition the area map
  overlap: 0  

warps:
  earth_save:
    time: 5  # initial savewarp pre-amashi
    req: WITHIN `Antarctica`
    to: ^save
    loads: true
  indra_save:
    time: 14.5
    req: NOT WITHIN `Menu` and Amashilama and ^mode != 'drone'
    to: ^save
    after: ^energy = $max_energy
    loads: true
  drone_save:
    time: 12
    req: NOT WITHIN `Menu` and ^mode == 'drone'
    to: ^save
    after: ^energy = $max_energy
    loads: true
  menu:
    time: 1
    req: NOT WITHIN `Menu` and ^flasks > 0
    to: Menu > Upgrade Menu > Physiology
    before: ^last = ^position
    base_movement: true
  exit_menu:
    time: 0.2
    req: WITHIN `Menu`
    to: ^last
    after: ^last = $default
    base_movement: true
  fast_travel_17_10:
    time: 12
    req: NOT WITHIN `Menu` and Map_17_10 and Fast_Travel
    to: Giguna > Giguna Northeast > Save Point
    after: ^energy = $max_energy

# TODO: under some conditions, fast travel indra can appear standing up
# 7s. I think it's immediately after savewarping though, so not very useful.

actions:
  - name: Recall Drone
    req: NOT WITHIN `Menu` and not ^breach and $can_recall
    do: ^mode = 'Indra'; ^position = ^indra
    # Can open the menu during this time
    time: 3  # it's slightly less in-area
  - name: Deploy Drone
    req: NOT WITHIN `Menu` and $can_deploy
    do: ^mode = 'drone'; ^indra = ^position
    time: 0.5

helpers:
  $melee: Ice_Axe or ^mode == 'drone'
  $boomerang: ^mode != 'drone' and Boomerang
  $can_damage: $melee or Boomerang
  $grab: ^mode != 'drone' and Ledge_Grab
  $climb: ^mode != 'drone' and Wall_Climb
  $hook: ^mode == 'drone' and Slingshot_Hook
  $hover: ^mode == 'drone' and Drone_Hover
  $can_deploy: Remote_Drone and ^mode != 'drone' and not Anuman
  $can_recall: ^mode == 'drone' and not Anuman
  $shockwave: ^mode != 'drone' and Shockwave

  $open: Infect
  $activate: Infect
  $platform: Infect
  $overheat: Infect
  $allegiance1: Infect
  $allegiance2: Infect{2}
  $unlock2: Infect{2}
  $unlock3: Infect{3}

  $more_refills: ^refills < $count(Power_Matrix)

  $max_energy:num: PER Nano_Points { 3 => 450, 2 => 400, 1 => 350, _ => 300 }

  $bs: boomerang_steering and $boomerang
  $offset: major_glitches and $melee
  $block_clip: minor_glitches and ^mode == 'drone'
  $block_clip_escape: minor_glitches and $hook

  $all_notes:itemList: >
    [Dear_Ernest, Researchers_Missing, Letter_from_Trace,
     Heretics_Tablet, Terminal_Breakthrough_1, Companies_Layoff, Record_Losses,
     Under_Siege]

  $save:action: ^save = ^position; ^energy = $max_energy
  $deploy_drone:action(newpos:SpotId): >
    ^mode = 'drone'; ^indra = ^position; ^position = ^newpos;
  $deploy_drone_and_move:action(dronepos:SpotId, indrapos:SpotId): >
    ^mode = 'drone'; ^indra = ^indrapos; ^position = ^dronepos;

  # entry rules
  # ^position is the old value
  $reset_old_area:action(newpos:SpotId): >
    IF (^position NOT WITHIN ^prev_area
        AND ^position NOT WITHIN `Menu`
        AND ^newpos NOT WITHIN $get_area(^position)) {
            IF (^newpos NOT WITHIN ^prev_area) {
                $reset_area(^prev_area);
            };
            ^prev_area = $get_area(^position);
    }
  $breach_entry:action(newsave:SpotId): >
    IF (NOT ^breach) { ^save = ^newsave; }


collect:
  Amashilama: ^save = `Glacier > Revival > Save Point`
  Flask: ^flasks += 1
  #Big_Flask: ^flasks += 2
  Infect: ^energy = $max_energy
  Health_Node: ^energy = $max_energy
  Power_Core: ^refills += 1
  Amagi_Stronghold_Wall_And_Boulder_1: >
    $skip(`Amagi > West Lake > Stronghold Ceiling Left > Knock Down Left Boulder`);
    $add_item(Amagi_Stronghold_Wall_1);
    $add_item(Amagi_Stronghold_Boulder_1);
  Amagi_Stronghold_Boulder_And_Wall_2: >
    $skip(`Amagi > West Lake > Stronghold Ceiling Right > Knock Down Right Boulder`);
    $add_item(Amagi_Stronghold_Wall_2);
    $add_item(Amagi_Stronghold_Boulder_2);
  Ebih_Waterfall_Both_Blocks: >
    $skip(`Ebih > Waterfall > Alcove > Block Left`);
    $skip(`Ebih > Waterfall > Alcove > Block Right`);
    $skip(`Ebih > Waterfall > Alcove Left > Block Left`);
    $skip(`Ebih > Waterfall > Alcove Right > Block Right`);
    $add_item(Ebih_Waterfall_Block_Right);
    $add_item(Ebih_Waterfall_Block_Left);
  Defeat_MUS_A_M20:
    $skip(`Amagi > West Lake > Cavern Refill Station > Break Wall`);
    $add_item(Amagi_Dragon_Eye_Passage);

settings:
  boomerang_steering:
    type: bool
  major_glitches:
    type: bool
  minor_glitches:
    type: bool